<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Commander Life Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { 
            height: 100%; 
            width: 100%;
            font-family: Arial, sans-serif; 
            background-color: #313030; 
            overflow: hidden; 
            margin: 0;
            padding: 0;
        }
        .grid-container { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Player panel container - holds both the player area and settings panel */
        .player-container {
            position: absolute;
            width: 50%;
            height: 50%;
            overflow: hidden; /* Important to hide the settings panel when not active */
        }
        
        /* Position the containers */
        .player-container.top-left {
            top: 0;
            left: 0;
        }
        
        .player-container.top-right {
            top: 0;
            right: 0;
        }
        
        .player-container.bottom-left {
            bottom: 0;
            left: 0;
        }
        
        .player-container.bottom-right {
            bottom: 0;
            right: 0;
        }
        
        /* Player panel (the colored life counter) */
        .player { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex; 
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center; 
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center; 
            color: rgb(0, 0, 0); 
            font-weight: bold; 
            border-radius: 0; /* Removed border radius for cleaner sliding */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-transition: transform 0.3s ease;
            transition: transform 0.3s ease;
            z-index: 10; /* Ensure player panel is above settings panel */
        }
        
        /* Settings panel (gray area behind player) */
        .settings-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5;
            color: white;
        }
        
        .settings-panel.top-left {
            top: 0;
            left: 0;
            transform: rotate(90deg);
        }
        .settings-panel.top-right {
            top: 0;
            right: 0;
            transform: rotate(-90deg);
        }
        .settings-panel.bottom-left {
            bottom: 0;
            left: 0;
            transform: rotate(90deg);
        }
        .settings-panel.bottom-right {
            bottom: 0;
            right: 0;
            transform: rotate(-90deg);
        }

        /* Individual setting buttons */
        .setting-btn {
            background-color: #555;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            min-width: 160px;
            margin-bottom: 15px;
        }
        
        .setting-btn:hover {
            background-color: #777;
        }
        
        /* New poison counter container */
        .poison-counter-container {
            display: flex;
            align-items: center;
            background-color: #555;
            border-radius: 5px;
            padding: 5px 10px;
            min-width: 160px;
            justify-content: space-between;
        }
        
        /* Poison counter arrows */
        .poison-arrow {
            color: white;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .poison-arrow:hover {
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        /* Poison counter display */
        .poison-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
        }
        
        .poison-value {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .poison-symbol {
            font-size: 0.9em;
            color: #8bc34a; /* Poison green color */
        }
        
        /* Poison indicator on main screen */
        .poison-indicator {
            position: absolute;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            color: #85f900fc; /* Poison green */
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .poison-indicator.visible {
            opacity: 1;
        }
        
        .player0 .poison-indicator {
            top: 10px;
            right: 10px;
            transform: rotate(90deg);
        }
        
        .player1 .poison-indicator {
            top: 10px;
            left: 10px;
            transform: rotate(-90deg);
        }
        
        .player2 .poison-indicator {
            bottom: 10px;
            right: 10px;
            transform: rotate(90deg);
        }
        
        .player3 .poison-indicator {
            bottom: 10px;
            left: 10px;
            transform: rotate(-90deg);
        }
        
        /* Arrow indicators for sliding */
        .arrow-indicator {
            position: absolute;
            color: white;
            font-size: 24px;
            z-index: 15;
            opacity: 0.7;
        }
        
        /* Position arrows based on player position */
        .player-container.top-left .arrow-indicator {
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .player-container.top-right .arrow-indicator {
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .player-container.bottom-left .arrow-indicator {
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .player-container.bottom-right .arrow-indicator {
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* Slide animation classes */
        .player-container.top-left.active .player {
            transform: translateX(-80%);
        }
        
        .player-container.top-right.active .player {
            transform: translateX(80%);
        }
        
        .player-container.bottom-left.active .player {
            transform: translateX(-80%);
        }
        
        .player-container.bottom-right.active .player {
            transform: translateX(80%);
        }
        
        /* Player colors */
        .player0 { 
            background-color: #f4b400; 
        }
        .player1 { 
            background-color: #db4437; 
        }
        .player2 { 
            background-color: #48ad4b; 
        }
        .player3 { 
            background-color: #4285f4; 
        }
        
        .command-damage { 
            font-size: 2.5em; 
            position: absolute; 
            text-align: center; 
            pointer-events: none;
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            margin: 0;
            line-height: 1;
        }
        .player0 .command-damage, .player2 .command-damage { 
            -webkit-transform: translate(-50%, -50%) rotate(90deg); 
            transform: translate(-50%, -50%) rotate(90deg); 
        }
        .player1 .command-damage, .player3 .command-damage { 
            -webkit-transform: translate(-50%, -50%) rotate(-90deg); 
            transform: translate(-50%, -50%) rotate(-90deg); 
        }
        .life-total { 
            font-size: 4em; 
            position: absolute; 
            text-align: center; 
            pointer-events: none;
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            margin: 0;
            line-height: 1;
        }
        .player0 .life-total, .player2 .life-total { 
            -webkit-transform: translate(-50%, -50%) rotate(90deg); 
            transform: translate(-50%, -50%) rotate(90deg); 
        }
        .player1 .life-total, .player3 .life-total { 
            -webkit-transform: translate(-50%, -50%) rotate(-90deg); 
            transform: translate(-50%, -50%) rotate(-90deg); 
        }
        .half { 
            position: absolute; 
            width: 100%; 
            height: 50%; 
            display: -webkit-box;
            display: -webkit-flex;
            display: flex; 
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center; 
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center; 
            font-size: 3em; 
            color: rgb(94, 93, 93); 
            font-weight: bold; 
            cursor: pointer; 
            -webkit-transition: background-color 0.2s; 
            transition: background-color 0.2s;
            line-height: 1;
            text-align: center;
        }
        .top-half 
		{ 
            top: 0;
            left: 0;
            margin: 0;
            line-height: 1;
		}
        .bottom-half { 
            bottom: 0;
            left: 0;
            margin: 0;
            line-height: 1;
			}
        .half.dimmed { background-color: rgba(0, 0, 0, 0.2); }
        .tap-counter { 
            position: absolute; 
            font-size: 1em; 
            opacity: 0; 
            -webkit-transition: opacity 0.2s; 
            transition: opacity 0.2s; 
        }
        .tap-counter.show { opacity: 1; }
        .top-half .tap-counter { top: 10%; color: rgb(0, 0, 0);}
        .bottom-half .tap-counter { bottom: 10%; color: rgb(0, 0, 0);}
        .player0 .tap-counter, .player2 .tap-counter { 
            -webkit-transform: rotate(90deg); 
            transform: rotate(90deg); 
        }
        .player1 .tap-counter, .player3 .tap-counter { 
            -webkit-transform: rotate(-90deg); 
            transform: rotate(-90deg); 
        }
        .player0 .minus, .player2 .minus { 
            display: inline-block;
            -webkit-transform: rotate(90deg); 
            transform: rotate(90deg); 
        }
        .player1 .minus, .player3 .minus { 
            display: inline-block;
            -webkit-transform: rotate(-90deg); 
            transform: rotate(-90deg); 
        }
        .commander-damage-container { 
            display: -webkit-box;
            display: -webkit-flex;
            display: flex; 
            position: absolute; 
        }
        .commander-damage-box { 
            width: 40px; 
            height: 40px; 
            display: -webkit-box;
            display: -webkit-flex;
            display: flex; 
            margin-right: 5px;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center; 
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center; 
            font-size: 1em; 
            color: white; 
            font-weight: bold; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .damage-1 { background-color: #db4437; }
        .damage-3 { background-color: #4285f4; }
        .damage-2 { background-color: #48ad4b; }
        .damage-0 { background-color: #f4b400; }
        .player0 .commander-damage-container { 
            left: 5%; 
            top: 50%; 
            -webkit-transform: translateY(-50%) rotate(90deg); 
            transform: translateY(-50%) rotate(90deg); 
        }
        .player2 .commander-damage-container { 
            left: 5%; 
            top: 50%; 
            -webkit-transform: translateY(-50%) rotate(90deg); 
            transform: translateY(-50%) rotate(90deg); 
        }
        .player1 .commander-damage-container { 
            right: 5%; 
            top: 50%; 
            -webkit-transform: translateY(-50%) rotate(-90deg); 
            transform: translateY(-50%) rotate(-90deg); 
        }
        .player3 .commander-damage-container { 
            right: 5%; 
            top: 50%; 
            -webkit-transform: translateY(-50%) rotate(-90deg); 
            transform: translateY(-50%) rotate(-90deg); 
        }
        .radial-menu { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            -webkit-transform: translate(-50%, -50%); 
            transform: translate(-50%, -50%); 
            display: -webkit-box;
            display: -webkit-flex;
            display: flex; 
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center; 
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center; 
            z-index: 20; /* Make sure menu is on top */
        }
        .menu-button { 
            font-size: 2em; 
            background-color: #333; 
            color: white; 
            border-radius: 50%; 
            padding: 20px; 
            cursor: pointer; 
            -webkit-transition: background 0.3s; 
            transition: background 0.3s; 
            z-index: 10; 
            display: -webkit-box;
            display: -webkit-flex;
            display: flex; 
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center; 
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center; 
        }
        .menu-button:hover { background-color: #444; }
        .menu-option { 
            position: absolute; 
            width: 120px; 
            height: 35px; 
            background-color: #333; 
            color: white; 
            border-radius: 10px; 
            display: -webkit-box;
            display: -webkit-flex;
            display: flex; 
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center; 
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center; 
            opacity: 0; 
            -webkit-transition: all 0.3s; 
            transition: all 0.3s; 
            font-size: 1em; 
            pointer-events: none; 
        }
        .menu-open .menu-option { 
            opacity: 1; 
            pointer-events: auto; 
        }
        .menu-option.restart { 
            -webkit-transform: translate(-70px, -120px); 
            transform: translate(-70px, -120px); 
        }
        .menu-option.full-screen { 
            -webkit-transform: translate(70px, -120px); 
            transform: translate(70px, -120px); 
        }
        .active-cmd-damage-div {
            background-image: -webkit-linear-gradient(rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.4) 100%);
            background-image: linear-gradient(rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.4) 100%);
        }
        .disabled {
            pointer-events: none; 
            display: none;
        }
        .hidden-container {
            pointer-events: none;
            opacity: 0.3;
        }
        .enabled-div {
            pointer-events: auto; 
            opacity: 1; 
        }
        
        /* New styles for the death feature */
        .player-dead {
            background-image: -webkit-linear-gradient(rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.4) 100%);
            background-image: linear-gradient(rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.4) 100%);
        }
        
        .skull {
            position: absolute;
            font-size: 5em;
            z-index: 5;
            pointer-events: none;
            top: 50%;
            left: 50%;
            display: none; /* Hide by default */
        }
        
        .player0 .skull, .player2 .skull {
            -webkit-transform: translate(-50%, -50%) rotate(90deg);
            transform: translate(-50%, -50%) rotate(90deg);
        }
        
        .player1 .skull, .player3 .skull {
            -webkit-transform: translate(-50%, -50%) rotate(-90deg);
            transform: translate(-50%, -50%) rotate(-90deg);
        }
        
        /* Hide life total when player is dead */
        .player-dead .life-total {
            display: none;
        }
    </style>
</head>
<body>
<div class="grid-container" id="gridContainer">
    <!-- Player 1 Container (top-left) -->
    <div class="player-container top-left" id="container0">
        <div class="settings-panel top-left">
            <div class="setting-btn" onclick="resetPlayerLife(0)">Reset Life</div>
            <div class="setting-btn" id="toggleDeadBtn0" onclick="togglePlayerDead(0)">Mark Dead</div>
            <div class="setting-btn" onclick="resetCommanderDamage(0)">Reset Cmd DMG</div>
            
            <!-- New Poison Counter Control -->
            <div class="poison-counter-container">
                <div class="poison-arrow" onclick="adjustPoisonCounter(0, -1)">−</div>
                <div class="poison-display">
                    <div class="poison-value" id="poison-value-0">0</div>
                    <div class="poison-symbol">☠</div>
                </div>
                <div class="poison-arrow" onclick="adjustPoisonCounter(0, 1)">+</div>
            </div>
        </div>
        <div class="player player0" id="player0">
            <div class="arrow-indicator">⚙️</div>
            <div class="command-damage disabled damage-0">Click To Return</div>
            <div class="life-total" id="life0">40</div>
            <div class="skull" id="skull0">☠️</div>
            <div class="poison-indicator" id="poison-indicator-0">0 ☠</div>
            <div class="half top-half" onclick="tapLife(0, -1, this)">
                <div class="minus">-</div>
                <div class="tap-counter" id="tapCounter0Minus">-1</div>
            </div>
            <div class="half bottom-half" onclick="tapLife(0, 1, this)">
                <div class="plus">+</div>
                <div class="tap-counter" id="tapCounter0Plus">+1</div>
            </div>
            <div class="commander-damage-container" id="commander-damage-container0">
                <div class="commander-damage-box damage-1" onclick="adjustCommanderDamage(0, 1)">0</div>
                <div class="commander-damage-box damage-2" onclick="adjustCommanderDamage(0, 2)">0</div>
                <div class="commander-damage-box damage-3" onclick="adjustCommanderDamage(0, 3)">0</div>
            </div>
        </div>
    </div>
    
    <!-- Player 2 Container (top-right) -->
    <div class="player-container top-right" id="container1">
        <div class="settings-panel top-right">
            <div class="setting-btn" onclick="resetPlayerLife(1)">Reset Life</div>
            <div class="setting-btn" id="toggleDeadBtn1" onclick="togglePlayerDead(1)">Mark Dead</div>
            <div class="setting-btn" onclick="resetCommanderDamage(1)">Reset Cmd DMG</div>
            
            <!-- New Poison Counter Control -->
            <div class="poison-counter-container">
                <div class="poison-arrow" onclick="adjustPoisonCounter(1, -1)">−</div>
                <div class="poison-display">
                    <div class="poison-value" id="poison-value-1">0</div>
                    <div class="poison-symbol">☠</div>
                </div>
                <div class="poison-arrow" onclick="adjustPoisonCounter(1, 1)">+</div>
            </div>
        </div>
        <div class="player player1" id="player1">
            <div class="arrow-indicator">⚙️</div>
            <div class="command-damage disabled damage-1">Click To Return</div>
            <div class="life-total" id="life1">40</div>
            <div class="skull" id="skull1">☠️</div>
            <div class="poison-indicator" id="poison-indicator-1">0 ☠</div>
            <div class="half top-half" onclick="tapLife(1, 1, this)">+
                <div class="tap-counter" id="tapCounter1Plus">+1</div>
            </div>
            <div class="half bottom-half" onclick="tapLife(1, -1, this)">
                <div class="minus">-</div>
                <div class="tap-counter" id="tapCounter1Minus">-1</div>
            </div>
            <div class="commander-damage-container" id="commander-damage-container1">
                <div class="commander-damage-box damage-0" onclick="adjustCommanderDamage(1, 0)">0</div>
                <div class="commander-damage-box damage-2" onclick="adjustCommanderDamage(1, 2)">0</div>
                <div class="commander-damage-box damage-3" onclick="adjustCommanderDamage(1, 3)">0</div>
            </div>
        </div>
    </div>
    
    <!-- Player 3 Container (bottom-left) -->
    <div class="player-container bottom-left" id="container2">
        <div class="settings-panel bottom-left">
            <div class="setting-btn" onclick="resetPlayerLife(2)">Reset Life</div>
            <div class="setting-btn" id="toggleDeadBtn2" onclick="togglePlayerDead(2)">Mark Dead</div>
            <div class="setting-btn" onclick="resetCommanderDamage(2)">Reset Cmd DMG</div>
            
            <!-- New Poison Counter Control -->
            <div class="poison-counter-container">
                <div class="poison-arrow" onclick="adjustPoisonCounter(2, -1)">−</div>
                <div class="poison-display">
                    <div class="poison-value" id="poison-value-2">0</div>
                    <div class="poison-symbol">☠</div>
                </div>
                <div class="poison-arrow" onclick="adjustPoisonCounter(2, 1)">+</div>
            </div>
        </div>
        <div class="player player2" id="player2">
            <div class="arrow-indicator">⚙️</div>
            <div class="command-damage disabled damage-2">Click To Return</div>
            <div class="life-total" id="life2">40</div>
            <div class="skull" id="skull2">☠️</div>
            <div class="poison-indicator" id="poison-indicator-2">0 ☠</div>
            <div class="half top-half" onclick="tapLife(2, -1, this)">
                <div class="minus">-</div>
                <div class="tap-counter" id="tapCounter2Minus">-1</div>
            </div>
            <div class="half bottom-half" onclick="tapLife(2, 1, this)">+
                <div class="tap-counter" id="tapCounter2Plus">+1</div>
            </div>
            <div class="commander-damage-container" id="commander-damage-container2">
                <div class="commander-damage-box damage-0" onclick="adjustCommanderDamage(2, 0)">0</div>
                <div class="commander-damage-box damage-1" onclick="adjustCommanderDamage(2, 1)">0</div>
                <div class="commander-damage-box damage-3" onclick="adjustCommanderDamage(2, 3)">0</div>
            </div>
        </div>
    </div>
    
    <!-- Player 4 Container (bottom-right) -->
    <div class="player-container bottom-right" id="container3">
        <div class="settings-panel bottom-right">
            <div class="setting-btn" onclick="resetPlayerLife(3)">Reset Life</div>
            <div class="setting-btn" id="toggleDeadBtn3" onclick="togglePlayerDead(3)">Mark Dead</div>
            <div class="setting-btn" onclick="resetCommanderDamage(3)">Reset Cmd DMG</div>
            
            <!-- New Poison Counter Control -->
            <div class="poison-counter-container">
                <div class="poison-arrow" onclick="adjustPoisonCounter(3, -1)">−</div>
                <div class="poison-display">
                    <div class="poison-value" id="poison-value-3">0</div>
                    <div class="poison-symbol">☠</div>
                </div>
                <div class="poison-arrow" onclick="adjustPoisonCounter(3, 1)">+</div>
            </div>
        </div>
        <div class="player player3" id="player3">
            <div class="arrow-indicator">⚙️</div>
            <div class="command-damage disabled damage-3">Click To Return</div>
            <div class="life-total" id="life3">40</div>
            <div class="skull" id="skull3">☠️</div>
            <div class="poison-indicator" id="poison-indicator-3">0 ☠</div>
            <div class="half top-half" onclick="tapLife(3, 1, this)">+
                <div class="tap-counter" id="tapCounter3Plus">+1</div>
            </div>
            <div class="half bottom-half" onclick="tapLife(3, -1, this)">
                <div class="minus">-</div>
                <div class="tap-counter" id="tapCounter3Minus">-1</div>
            </div>
            <div class="commander-damage-container" id="commander-damage-container3">
                <div class="commander-damage-box damage-0" onclick="adjustCommanderDamage(3, 0)">0</div>
                <div class="commander-damage-box damage-1" onclick="adjustCommanderDamage(3, 1)">0</div>
                <div class="commander-damage-box damage-2" onclick="adjustCommanderDamage(3, 2)">0</div>
            </div>
        </div>
    </div>
    
    <div class="radial-menu" id="radialMenu">
        <div class="menu-button" onclick="toggleMenu()">Menu</div>
        <div class="menu-option restart" onclick="restartGame()">RESTART</div>
    </div>
</div>
<script>
    var playerLives = [40, 40, 40, 40];
    var commanderDamages = [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]]; // Array to track commander damage for each player against others
    var playersDead = [false, false, false, false]; // Track player death status
    var poisonCounters = [0, 0, 0, 0]; // New: Track poison counters for each player
    var tapCounts = { plus: [0, 0, 0, 0], minus: [0, 0, 0, 0] };
    var tapTimeouts = { plus: [null, null, null, null], minus: [null, null, null, null] };
    var inCommanderDamageMode = false; // Track if any player is in commander damage mode
    var activePlayerPanel = -1; // Track which player's panel is slid out
    
    // Touch event variables
    var touchStartX = 0;
    var touchStartY = 0;
    
    // Initialize: Hide all skulls and set up touch events
    window.onload = function() {
        for (var i = 0; i < 4; i++) {
            document.getElementById("skull" + i).style.display = "none";
            setupTouchEvents(i);
            updatePoisonIndicator(i); // Initialize poison indicators
        }
    };

    function togglePlayerPanel(playerIndex) {
        var containerElement = document.getElementById("container" + playerIndex);
        
        // If panel already active, close it
        if (activePlayerPanel === playerIndex) {
            removeClass(containerElement, "active");
            activePlayerPanel = -1;
            return;
        }
        
        // If another panel is active, close it first
        if (activePlayerPanel !== -1) {
            removeClass(document.getElementById("container" + activePlayerPanel), "active");
        }
        
        // Open this panel
        addClass(containerElement, "active");
        activePlayerPanel = playerIndex;
        
        // Update toggle button text based on current state
        updateToggleButtonText(playerIndex);
    }

    function setupTouchEvents(playerIndex) {
        var playerElement = document.getElementById("player" + playerIndex);
        var containerElement = document.getElementById("container" + playerIndex);
        
        // Arrow indicator click handler
        playerElement.querySelector(".arrow-indicator").addEventListener("click", function(e) {
            e.stopPropagation(); // Prevent event from bubbling to player element
            togglePlayerPanel(playerIndex);
        });
        
        // Setup touch events for swipe
        playerElement.addEventListener('touchstart', function(e) {
            if (inCommanderDamageMode) return; // Don't allow swipe during commander damage mode
            
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, false);
        
        playerElement.addEventListener('touchmove', function(e) {
            if (inCommanderDamageMode) return;
            
            var touchX = e.touches[0].clientX;
            var touchY = e.touches[0].clientY;
            
            var deltaX = touchX - touchStartX;
            var deltaY = touchY - touchStartY;
            
            // If more horizontal than vertical movement, it's a horizontal swipe
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                e.preventDefault(); // Prevent scrolling
            }
        }, false);
        
        playerElement.addEventListener('touchend', function(e) {
            if (inCommanderDamageMode) return;
            
            var touchEndX = e.changedTouches[0].clientX;
            var touchEndY = e.changedTouches[0].clientY;
            
            var deltaX = touchEndX - touchStartX;
            var deltaY = touchEndY - touchStartY;
            
            // If more horizontal than vertical movement and significant swipe
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                // For left players (0 and 2), swipe left to open
                if ((playerIndex === 0 || playerIndex === 2) && deltaX < 0) {
                    togglePlayerPanel(playerIndex);
                }
                // For right players (1 and 3), swipe right to open
                else if ((playerIndex === 1 || playerIndex === 3) && deltaX > 0) {
                    togglePlayerPanel(playerIndex);
                }
                // For all players, opposite swipe to close
                else if (hasClass(containerElement, "active")) {
                    togglePlayerPanel(playerIndex);
                }
            }
        }, false);
    }

    // Function to adjust poison counters
    function adjustPoisonCounter(player, change) {
        // Don't allow negative poison counters
        if (poisonCounters[player] + change < 0) return;
        
        poisonCounters[player] += change;
        document.getElementById("poison-value-" + player).textContent = poisonCounters[player];
        updatePoisonIndicator(player);
        
        // Check if player reached 10 poison counters (game rule)
        if (poisonCounters[player] >= 10 && !playersDead[player]) {
            killPlayer(player);
        } 
        // Check if player should be revived from poison reduction
        else if (poisonCounters[player] < 10 && playersDead[player]) {
            // Check if they should stay dead from other causes
            var shouldStayDead = playerLives[player] <= 0;
            
            if (!shouldStayDead) {
                // Check commander damage
                for (var i = 0; i < 3; i++) {
                    var damage = commanderDamages[player][i];
                    if (damage >= 21) {
                        shouldStayDead = true;
                        break;
                    }
                }
            }
            
            if (!shouldStayDead) {
                revivePlayer(player);
            }
        }
    }
    
    // Function to update poison indicator visibility
    function updatePoisonIndicator(player) {
        var indicator = document.getElementById("poison-indicator-" + player);
        if (poisonCounters[player] > 0) {
            indicator.textContent = poisonCounters[player] + " ☠";
            addClass(indicator, "visible");
        } else {
            removeClass(indicator, "visible");
        }
    }
    
    // Function to reset poison counters
    function resetPoisonCounter(player) {
        poisonCounters[player] = 0;
        document.getElementById("poison-value-" + player).textContent = "0";
        updatePoisonIndicator(player);
        
        // Check if player should be revived
        checkPlayerStatus(player);
    }
    
     function updateToggleButtonText(playerIndex) {
        var button = document.getElementById("toggleDeadBtn" + playerIndex);
        button.textContent = playersDead[playerIndex] ? "Revive Player" : "Mark Dead";
    }
    
    function resetPlayerLife(player) {
        playerLives[player] = 40;
        document.getElementById("life" + player).textContent = "40";
        if (playersDead[player]) {
            revivePlayer(player);
        }
        
        // Close the panel
        togglePlayerPanel(player);
    }
    
    function togglePlayerDead(player) {
        if (playersDead[player]) {
            revivePlayer(player);
        } else {
            killPlayer(player);
        }
        
        // Update the button text
        updateToggleButtonText(player);
    }
    
    function resetCommanderDamage(player) {
        console.log("Resetting commander damage for player " + player);

        // Reset all commander damage dealt TO this player
        for (var i = 0; i < 3; i++) {
            commanderDamages[player][i] = 0;
            console.log(commanderDamages[player]);
        }
        
        // Reset all commander damage boxes showing damage TO this player
        for (var i = 0; i < 4; i++) {
            if (i !== player) {
                var boxIndex = (i < player) ? i : i - 1;
                var box = document.querySelector("#player" + player + " .commander-damage-box.damage-" + i);
                if (box) {
                    box.textContent = "0";
                }
            }
        }
        
        // Check if player should be revived after resetting damage
        checkPlayerStatus(player);
        
        // Close the panel
        togglePlayerPanel(player);
    }
    
    function tapLife(player, change, divElement) {
        // If a panel is open, close it first
        if (activePlayerPanel !== -1) {
            togglePlayerPanel(activePlayerPanel);
            return;
        }
        
        var isPlus = change > 0;
        var halfClass = divElement.classList.contains("top-half") ? "top-half" : "bottom-half";
        var counterId = isPlus ? "tapCounter" + player + "Plus" : "tapCounter" + player + "Minus";
        var counterElement = document.getElementById(counterId);
        var halfElement = document.querySelector("#player" + player + " ." + halfClass);
        var tapType = isPlus ? "plus" : "minus";
        var playerLife = document.querySelector("#player" + player).querySelector(".life-total");
        
        if(!hasClass(playerLife, "disabled")) {
            playerLives[player] += change;
            document.getElementById("life" + player).textContent = playerLives[player];
            
            // Check if player died from life loss
            if (playerLives[player] <= 0 && !playersDead[player]) {
                killPlayer(player);
            } 
            // Check if player should be revived from positive life
            else if (playerLives[player] > 0 && playersDead[player]) {
                // Check if they should stay dead from commander damage
                var shouldStayDead = false;
                
                // Check each opponent's commander damage
                for (var i = 0; i < 3; i++) {
                    var damageIndex = (i < player) ? i : i + 1;
                    var damage = commanderDamages[player][i];
                    if (damage >= 21) {
                        shouldStayDead = true;
                        break;
                    }
                }
                
                if (!shouldStayDead) {
                    revivePlayer(player);
                }
            }
        } else {
            var commandDamage = document.querySelector("#player" + player).querySelector(".command-damage");
            var totalCmdDamage = parseInt(commandDamage.textContent);
            totalCmdDamage += change;
            var cmdDamagePlayerLife = document.querySelector(".player.active-cmd-damage-div");
            var cmdDamagePlayerNumber = cmdDamagePlayerLife.id[cmdDamagePlayerLife.id.length - 1];
            
            // Update the commander damage for tracking
            var targetPlayer = parseInt(cmdDamagePlayerNumber);
            var fromPlayer = player;
            var dmgIdx = (fromPlayer < targetPlayer) ? fromPlayer : fromPlayer - 1;
            commanderDamages[targetPlayer][dmgIdx] = totalCmdDamage;
            
            playerLives[cmdDamagePlayerNumber] += (change * -1);
            document.getElementById("life" + cmdDamagePlayerNumber).textContent = playerLives[cmdDamagePlayerNumber];
            commandDamage.textContent = totalCmdDamage;
            
            // Update boxes with current damage values
            var boxes = cmdDamagePlayerLife.querySelectorAll(".commander-damage-box");
            for (var i = 0; i < boxes.length; i++) {
                var box = boxes[i];
                var damageClass = getDamageClass(box);
                var damageCounter = document.querySelector(".command-damage." + damageClass);
                box.textContent = parseInt(damageCounter.textContent) || 0;
            }
            
            // Check if player died from commander damage (21+)
            if (totalCmdDamage >= 21 && !playersDead[cmdDamagePlayerNumber]) {
                killPlayer(cmdDamagePlayerNumber);
            } 
            // Check if player should be revived now that commander damage is below 21
            else if (totalCmdDamage < 21 && playersDead[cmdDamagePlayerNumber]) {
                // Check if they should stay dead from life total or other commander damage
                var shouldStayDead = playerLives[cmdDamagePlayerNumber] <= 0;
                
                if (!shouldStayDead) {
                    // Check other commander damages
                    for (var i = 0; i < 3; i++) {
                        if (i === dmgIdx) continue; // Skip the one we just changed
                        
                        var damage = commanderDamages[cmdDamagePlayerNumber][i];
                        if (damage >= 21) {
                            shouldStayDead = true;
                            break;
                        }
                    }
                }
                
                if (!shouldStayDead) {
                    revivePlayer(cmdDamagePlayerNumber);
                }
            }
            
            // Check if player died from life loss
            if (playerLives[cmdDamagePlayerNumber] <= 0 && !playersDead[cmdDamagePlayerNumber]) {
                killPlayer(cmdDamagePlayerNumber);
            }
            // Similar check for revival if life is positive and no commander damage is fatal
            else if (playerLives[cmdDamagePlayerNumber] > 0 && playersDead[cmdDamagePlayerNumber]) {
                var shouldStayDead = false;
                
                // Check each opponent's commander damage
                for (var i = 0; i < 3; i++) {
                    var damage = commanderDamages[cmdDamagePlayerNumber][i];
                    if (damage >= 21) {
                        shouldStayDead = true;
                        break;
                    }
                }
                
                if (!shouldStayDead) {
                    revivePlayer(cmdDamagePlayerNumber);
                }
            }
        }
        
        tapCounts[tapType][player] += change;
        counterElement.textContent = (isPlus ? "+" : "") + tapCounts[tapType][player];
        addClass(counterElement, "show");
        
        addClass(halfElement, "dimmed");
        setTimeout(function() { removeClass(halfElement, "dimmed"); }, 200);
        
        clearTimeout(tapTimeouts[tapType][player]);
        tapTimeouts[tapType][player] = setTimeout(function() {
            tapCounts[tapType][player] = 0;
            removeClass(counterElement, "show");
        }, 2000);
    }
    
    function killPlayer(player) {
        console.log(`kill ${player}`);
        if (playersDead[player]) return; // If already dead, do nothing
        
        playersDead[player] = true;
        var playerElement = document.getElementById("player" + player);
        addClass(playerElement, "player-dead");
        
        // Show skull
        document.getElementById("skull" + player).style.display = "block";
        
        // Update button text if panel is open
        updateToggleButtonText(player);
    }
    
    function revivePlayer(player) {
        console.log(`Revive ${player}`);
        if (!playersDead[player]) return; // If not dead, do nothing
        
        playersDead[player] = false;
        var playerElement = document.getElementById("player" + player);
        removeClass(playerElement, "player-dead");
        
        // Hide skull
        document.getElementById("skull" + player).style.display = "none";
        
        // Update button text if panel is open
        updateToggleButtonText(player);
    }
    
    function checkPlayerStatus(player) {
        // This function checks if a player should be dead or alive based on their
        // current life total and commander damage values
        var shouldBeDead = false;
        
        // Check life total
        if (playerLives[player] <= 0) {
            shouldBeDead = true;
        } else {
            // Check all commander damages to this player
            for (var i = 0; i < 3; i++) {
                var damage = commanderDamages[player][i];
                if (damage >= 21) {
                    shouldBeDead = true;
                    break;
                }
            }
        }
        
        // Update player state if needed
        if (shouldBeDead && !playersDead[player]) {
            killPlayer(player);
        } else if (!shouldBeDead && playersDead[player]) {
            revivePlayer(player);
        }
    }

    function adjustCommanderDamage(fromPlayer, toPlayer) {
        // Close any open panel first
        if (activePlayerPanel !== -1) {
            togglePlayerPanel(activePlayerPanel);
            return;
        }
        
        // Don't allow entering commander damage mode if already in it
        if (inCommanderDamageMode) {
            return;
        }
        
        inCommanderDamageMode = true;
        
        var currentPlayer = document.querySelector(".player.player" + fromPlayer);
        addClass(currentPlayer, "active-cmd-damage-div");
        var lifeTotal = currentPlayer.querySelector(".life-total");
        addClass(lifeTotal, "disabled");
        var halfElements = currentPlayer.querySelectorAll(".half");
        for (var i = 0; i < halfElements.length; i++) {
            addClass(halfElements[i], "disabled");
        }
        var commandDamageText = currentPlayer.querySelector(".command-damage");
        removeClass(commandDamageText, "disabled");
        
        setTimeout(function() {
            currentPlayer.setAttribute("onclick", "enableDiv(this)");
        }, 200);
        
        var commanderDamageBox = document.querySelectorAll("#player" + fromPlayer + " .commander-damage-box");
        for (var i = 0; i < commanderDamageBox.length; i++) {
            var box = commanderDamageBox[i];
            var damageClass = getDamageClass(box);
            var damageCounter = document.querySelector(".command-damage." + damageClass);
            damageCounter.textContent = parseInt(box.textContent) || 0;
            removeClass(damageCounter, "disabled");
        }
        
        for(var i = 0; i < 4; i++) {
            if(i != fromPlayer) {
                var player = document.querySelector("#player" + i);
                addClass(player.querySelector(".life-total"), "disabled");
            }
        }
        
        // Hide all other commander damage containers except for the active player
        for (var i = 0; i < 4; i++) {
            if (i !== fromPlayer) {
                var container = document.getElementById("commander-damage-container" + i);
                addClass(container, "hidden-container");
            }
        }
        
		var arrows = document.querySelectorAll(".arrow-indicator");
		for (var i = 0; i < arrows.length; i++) {
    		arrows[i].style.display = "none";
		}
    }
    
    function toggleMenu() {
        var menu = document.getElementById("radialMenu");
        if (hasClass(menu, "menu-open")) {
            removeClass(menu, "menu-open");
        } else {
            addClass(menu, "menu-open");
        }
    }
    
    function enableDiv(currentPlayer) {
        removeClass(currentPlayer, 'active-cmd-damage-div');
        currentPlayer.removeAttribute("onclick");
        var halfElements = currentPlayer.querySelectorAll(".half");
        for (var i = 0; i < halfElements.length; i++) {
            removeClass(halfElements[i], "disabled");
        }
        var playerId = currentPlayer.id[currentPlayer.id.length - 1];
        var commandDamageText = currentPlayer.querySelector(".command-damage");
        addClass(commandDamageText, "disabled");
        
        var boxes = currentPlayer.querySelectorAll(".commander-damage-box");
        for (var i = 0; i < boxes.length; i++) {
            var box = boxes[i];
            var damageClass = getDamageClass(box);
            var damageCounter = document.querySelector(".command-damage." + damageClass);
            box.textContent = parseInt(damageCounter.textContent) || 0;
            damageCounter.textContent = "Click To Return";
        }
        
        var lifeTotal = currentPlayer.querySelector(".life-total");
        removeClass(lifeTotal, "disabled");
        var players = document.querySelectorAll(".player");
        for (var i = 0; i < players.length; i++) {
            removeClass(players[i].querySelector(".life-total"), "disabled");
        }
        var commandDamageEachPlayer = document.querySelectorAll(".command-damage");
        for (var i = 0; i < commandDamageEachPlayer.length; i++) {
            addClass(commandDamageEachPlayer[i], "disabled");
        }
        
        // Show all commander damage containers again
        for (var i = 0; i < 4; i++) {
            var container = document.getElementById("commander-damage-container" + i);
            removeClass(container, "hidden-container");
        }
        

		var arrows = document.querySelectorAll(".arrow-indicator");
		for (var i = 0; i < arrows.length; i++) {
			arrows[i].style.display = "block";
		}
				
        // Check if player status should change after updating commander damage
        for (var i = 0; i < 4; i++) {
            checkPlayerStatus(i);
        }
        
        // Exit commander damage mode
        inCommanderDamageMode = false;
    }
    
    // Helper functions for classList compatibility
    function hasClass(element, className) {
        if (element.classList) {
            return element.classList.contains(className);
        }
        return (' ' + element.className + ' ').indexOf(' ' + className + ' ') > -1;
    }
    
    function addClass(element, className) {
        if (element.classList) {
            element.classList.add(className);
        } else if (!hasClass(element, className)) {
            element.className += ' ' + className;
        }
    }
    
    function removeClass(element, className) {
        if (element.classList) {
            element.classList.remove(className);
        } else {
            element.className = element.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
        }
    }
    
    function getDamageClass(element) {
        var classes = element.className.split(' ');
        for (var i = 0; i < classes.length; i++) {
            if (classes[i].indexOf('damage-') === 0) {
                return classes[i];
            }
        }
        return '';
    }
        
    function tapLife(player, change, divElement) {
        // If a panel is open, close it first
        if (activePlayerPanel !== -1) {
            togglePlayerPanel(activePlayerPanel);
            return;
        }
        
        var isPlus = change > 0;
        var halfClass = divElement.classList.contains("top-half") ? "top-half" : "bottom-half";
        var counterId = isPlus ? "tapCounter" + player + "Plus" : "tapCounter" + player + "Minus";
        var counterElement = document.getElementById(counterId);
        var halfElement = document.querySelector("#player" + player + " ." + halfClass);
        var tapType = isPlus ? "plus" : "minus";
        var playerLife = document.querySelector("#player" + player).querySelector(".life-total");
        
        if(!hasClass(playerLife, "disabled")) {
            playerLives[player] += change;
            document.getElementById("life" + player).textContent = playerLives[player];
            
            // Check if player died from life loss
            if (playerLives[player] <= 0 && !playersDead[player]) {
                killPlayer(player);
            } 
            // Check if player should be revived from positive life
            else if (playerLives[player] > 0 && playersDead[player]) {
                // Check if they should stay dead from commander damage
                var shouldStayDead = false;
                
                // Check each opponent's commander damage
                for (var i = 0; i < 3; i++) {
                    var damageIndex = (i < player) ? i : i + 1;
                    var damage = commanderDamages[player][i];
                    if (damage >= 21) {
                        shouldStayDead = true;
                        break;
                    }
                }
                
                if (!shouldStayDead) {
                    revivePlayer(player);
                }
            }
        } else {
            var commandDamage = document.querySelector("#player" + player).querySelector(".command-damage");
            var totalCmdDamage = parseInt(commandDamage.textContent);
            totalCmdDamage += change;
            var cmdDamagePlayerLife = document.querySelector(".player.active-cmd-damage-div");
            var cmdDamagePlayerNumber = cmdDamagePlayerLife.id[cmdDamagePlayerLife.id.length - 1];
            
            // Update the commander damage for tracking
            var targetPlayer = parseInt(cmdDamagePlayerNumber);
            var fromPlayer = player;
            var dmgIdx = (fromPlayer < targetPlayer) ? fromPlayer : fromPlayer - 1;
            commanderDamages[targetPlayer][dmgIdx] = totalCmdDamage;
            
            playerLives[cmdDamagePlayerNumber] += (change * -1);
            document.getElementById("life" + cmdDamagePlayerNumber).textContent = playerLives[cmdDamagePlayerNumber];
            commandDamage.textContent = totalCmdDamage;
            
            // Update boxes with current damage values
            var boxes = cmdDamagePlayerLife.querySelectorAll(".commander-damage-box");
            for (var i = 0; i < boxes.length; i++) {
                var box = boxes[i];
                var damageClass = getDamageClass(box);
                var damageCounter = document.querySelector(".command-damage." + damageClass);
                box.textContent = parseInt(damageCounter.textContent) || 0;
            }
            
            // Check if player died from commander damage (21+)
            if (totalCmdDamage >= 21 && !playersDead[cmdDamagePlayerNumber]) {
                killPlayer(cmdDamagePlayerNumber);
            } 
            // Check if player should be revived now that commander damage is below 21
            else if (totalCmdDamage < 21 && playersDead[cmdDamagePlayerNumber]) {
                // Check if they should stay dead from life total or other commander damage
                var shouldStayDead = playerLives[cmdDamagePlayerNumber] <= 0;
                
                if (!shouldStayDead) {
                    // Check other commander damages
                    for (var i = 0; i < 3; i++) {
                        if (i === dmgIdx) continue; // Skip the one we just changed
                        
                        var damage = commanderDamages[cmdDamagePlayerNumber][i];
                        if (damage >= 21) {
                            shouldStayDead = true;
                            break;
                        }
                    }
                }
                
                if (!shouldStayDead) {
                    revivePlayer(cmdDamagePlayerNumber);
                }
            }
            
            // Check if player died from life loss
            if (playerLives[cmdDamagePlayerNumber] <= 0 && !playersDead[cmdDamagePlayerNumber]) {
                killPlayer(cmdDamagePlayerNumber);
            }
            // Similar check for revival if life is positive and no commander damage is fatal
            else if (playerLives[cmdDamagePlayerNumber] > 0 && playersDead[cmdDamagePlayerNumber]) {
                var shouldStayDead = false;
                
                // Check each opponent's commander damage
                for (var i = 0; i < 3; i++) {
                    var damage = commanderDamages[cmdDamagePlayerNumber][i];
                    if (damage >= 21) {
                        shouldStayDead = true;
                        break;
                    }
                }
                
                if (!shouldStayDead) {
                    revivePlayer(cmdDamagePlayerNumber);
                }
            }
        }
        
        tapCounts[tapType][player] += change;
        counterElement.textContent = (isPlus ? "+" : "") + tapCounts[tapType][player];
        addClass(counterElement, "show");
        
        addClass(halfElement, "dimmed");
        setTimeout(function() { removeClass(halfElement, "dimmed"); }, 200);
        
        clearTimeout(tapTimeouts[tapType][player]);
        tapTimeouts[tapType][player] = setTimeout(function() {
            tapCounts[tapType][player] = 0;
            removeClass(counterElement, "show");
        }, 2000);
    }

    function restartGame() { 
        // Reset player lives
        playerLives = [40, 40, 40, 40];
        for (var i = 0; i < 4; i++) {
            document.getElementById("life" + i).textContent = "40";
            revivePlayer(i);
            resetPoisonCounter(i);
        }
        
        // Reset commander damages
        commanderDamages = [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]];
        var commanderDamageBoxes = document.querySelectorAll(".commander-damage-box");
        for (var i = 0; i < commanderDamageBoxes.length; i++) {
            commanderDamageBoxes[i].textContent = "0";
        }
        
        // Reset player death status
        playersDead = [false, false, false, false];
        
        // Reset commander damage mode
        inCommanderDamageMode = false;
        
        // Close any open panel
        if (activePlayerPanel !== -1) {
            togglePlayerPanel(activePlayerPanel);
        }
        
        // Make sure all commander damage containers are visible
        for (var i = 0; i < 4; i++) {
            var container = document.getElementById("commander-damage-container" + i);
            removeClass(container, "hidden-container");
        }
        
		var arrows = document.querySelectorAll(".arrow-indicator");
		for (var i = 0; i < arrows.length; i++) {
    		arrows[i].style.display = "block";
		}
        
        // Close menu
        removeClass(document.getElementById("radialMenu"), "menu-open");
        
        // Update toggle button texts
        for (var i = 0; i < 4; i++) {
            updateToggleButtonText(i);
        }
    }
</script>
</body>
</html>