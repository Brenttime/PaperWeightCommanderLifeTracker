<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Commander Life Tracker</title>
        <style>
            
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body,
            html {
                height: 100%;
                width: 100%;
                font-family: Arial, sans-serif;
                background-color: #0d1117;
                color: #f0f6fc;
                overflow: hidden;
                margin: 0;
                padding: 0;
            }

            .grid-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            /* Player panel container - holds both the player area and settings panel */
            .player-container {
                position: absolute;
                width: 50%;
                height: 50%;
                overflow: hidden;
                /* Important to hide the settings panel when not active */
            }

            /* Position the containers */
            .player-container.top-left {
                top: 0;
                left: 0;
            }

            .player-container.top-right {
                top: 0;
                right: 0;
            }

            .player-container.bottom-left {
                bottom: 0;
                left: 0;
            }

            .player-container.bottom-right {
                bottom: 0;
                right: 0;
            }

            /* Player panel (the colored life counter) */
            .player {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: -webkit-box;
                display: -webkit-flex;
                display: flex;
                -webkit-box-pack: center;
                -webkit-justify-content: center;
                justify-content: center;
                -webkit-box-align: center;
                -webkit-align-items: center;
                align-items: center;
                color: rgb(0, 0, 0);
                font-weight: bold;
                border-radius: 0;
                /* Removed border radius for cleaner sliding */
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-transition: transform 0.3s ease;
                transition: transform 0.3s ease;
                z-index: 10;
                /* Ensure player panel is above settings panel */
            }

            /* Settings panel (gray area behind player) */
            .settings-panel {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 5;
                color: white;
            }

            .settings-panel.top-left {
                top: 0;
                left: 0;
                transform: rotate(90deg);
            }

            .settings-panel.top-right {
                top: 0;
                right: 0;
                transform: rotate(-90deg);
            }

            .settings-panel.bottom-left {
                bottom: 0;
                left: 0;
                transform: rotate(90deg);
            }

            .settings-panel.bottom-right {
                bottom: 0;
                right: 0;
                transform: rotate(-90deg);
            }

            /* Individual setting buttons */
            .setting-btn {
                background-color: #21262d;
                color: #f0f6fc;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                text-align: center;
                min-width: 160px;
                margin-bottom: 15px;
                border: 1px solid #30363d;
            }

            .setting-btn:hover {
                background-color: #30363d;
            }

            /* Partner toggle button styling */
            .partner-toggle {
                margin-bottom: 15px;
            }

            .partner {
                margin-top: 10px;
            }

            .partner-toggle.active {
                background-color: #238636;
                border: 1px solid #2ea043;
            }

            /* New poison counter container */
            .poison-counter-container {
                display: flex;
                align-items: center;
                background-color: #21262d;
                border: 1px solid #30363d;
                border-radius: 5px;
                padding: 5px 10px;
                min-width: 160px;
                justify-content: space-between;
            }

            /* Poison counter arrows */
            .poison-arrow {
                color: #f0f6fc;
                cursor: pointer;
                font-size: 18px;
                padding: 5px;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #161b22;
                border-radius: 50%;
                transition: background-color 0.2s;
            }

            .poison-arrow:hover {
                background-color: #30363d;
            }

            /* Poison counter display */
            .poison-display {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 0 10px;
            }

            .poison-value {
                font-size: 1.4em;
                font-weight: bold;
                margin-bottom: 2px;
            }

            .poison-symbol {
                font-size: 0.9em;
                color: #7c3aed;
                /* Dark mode poison purple */
            }

            /* Poison indicator on main screen */
            .poison-indicator {
                position: absolute;
                font-size: 1.2em;
                font-weight: bold;
                display: flex;
                align-items: center;
                color: #a855f7;
                /* Dark mode poison purple */
                opacity: 0;
                transition: opacity 0.3s;
            }

            .poison-indicator.visible {
                opacity: 1;
            }

            .player0 .poison-indicator {
                top: 10px;
                right: 10px;
                transform: rotate(90deg);
            }

            .player1 .poison-indicator {
                top: 10px;
                left: 10px;
                transform: rotate(-90deg);
            }

            .player2 .poison-indicator {
                bottom: 10px;
                right: 10px;
                transform: rotate(90deg);
            }

            .player3 .poison-indicator {
                bottom: 10px;
                left: 10px;
                transform: rotate(-90deg);
            }

            /* Arrow indicators for sliding */
            .arrow-indicator {
                position: absolute;
                color: #8b949e;
                font-size: 24px;
                z-index: 15;
                opacity: 0.7;
            }

            /* Position arrows based on player position */
            .player-container.top-left .arrow-indicator {
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
            }

            .player-container.top-right .arrow-indicator {
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
            }

            .player-container.bottom-left .arrow-indicator {
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
            }

            .player-container.bottom-right .arrow-indicator {
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
            }

            /* Slide animation classes */
            .player-container.top-left.active .player {
                transform: translateX(-80%);
            }

            .player-container.top-right.active .player {
                transform: translateX(80%);
            }

            .player-container.bottom-left.active .player {
                transform: translateX(-80%);
            }

            .player-container.bottom-right.active .player {
                transform: translateX(80%);
            }

            /* Player colors - Deep dark mode palette */
            .player0 {
                background-color: #da3633;
            }

            .player1 {
                background-color: #238636;
            }

            .player2 {
                background-color: #1f6feb;
            }

            .player3 {
                background-color: #fb8500;
            }

            .command-damage {
                font-size: 2.5em;
                position: absolute;
                text-align: center;
                pointer-events: none;
                top: 50%;
                left: 50%;
                -webkit-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
                margin: 0;
                line-height: 1;
            }

            .player0 .command-damage,
            .player2 .command-damage {
                -webkit-transform: translate(-50%, -50%) rotate(90deg);
                transform: translate(-50%, -50%) rotate(90deg);
            }

            .player1 .command-damage,
            .player3 .command-damage {
                -webkit-transform: translate(-50%, -50%) rotate(-90deg);
                transform: translate(-50%, -50%) rotate(-90deg);
            }

            .life-total {
                font-size: 4em;
                position: absolute;
                text-align: center;
                pointer-events: none;
                top: 50%;
                left: 50%;
                -webkit-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
                margin: 0;
                line-height: 1;
            }

            .player0 .life-total,
            .player2 .life-total {
                -webkit-transform: translate(-50%, -50%) rotate(90deg);
                transform: translate(-50%, -50%) rotate(90deg);
            }

            .player1 .life-total,
            .player3 .life-total {
                -webkit-transform: translate(-50%, -50%) rotate(-90deg);
                transform: translate(-50%, -50%) rotate(-90deg);
            }

            .half {
                position: absolute;
                width: 100%;
                height: 50%;
                display: -webkit-box;
                display: -webkit-flex;
                display: flex;
                -webkit-box-pack: center;
                -webkit-justify-content: center;
                justify-content: center;
                -webkit-box-align: center;
                -webkit-align-items: center;
                align-items: center;
                font-size: 3em;
                color: black;
                font-weight: bold;
                cursor: pointer;
                -webkit-transition: background-color 0.2s;
                transition: background-color 0.2s;
                line-height: 1;
                text-align: center;
            }

            .top-half {
                top: 0;
                left: 0;
                margin: 0;
                line-height: 1;
            }

            .bottom-half {
                bottom: 0;
                left: 0;
                margin: 0;
                line-height: 1;
            }

            .half.dimmed {
                background-color: rgba(0, 0, 0, 0.2);
            }

            .tap-counter {
                position: absolute;
                font-size: 1em;
                opacity: 0;
                -webkit-transition: opacity 0.2s;
                transition: opacity 0.2s;
            }

            .tap-counter.show {
                opacity: 1;
            }

            .top-half .tap-counter {
                top: 10%;
                color: rgb(0, 0, 0);
            }

            .bottom-half .tap-counter {
                bottom: 10%;
                color: rgb(0, 0, 0);
            }

            .player0 .tap-counter,
            .player2 .tap-counter {
                -webkit-transform: rotate(90deg);
                transform: rotate(90deg);
            }

            .player1 .tap-counter,
            .player3 .tap-counter {
                -webkit-transform: rotate(-90deg);
                transform: rotate(-90deg);
            }

            .player0 .minus,
            .player2 .minus {
                display: inline-block;
                -webkit-transform: rotate(90deg);
                transform: rotate(90deg);
            }

            .player1 .minus,
            .player3 .minus {
                display: inline-block;
                -webkit-transform: rotate(-90deg);
                transform: rotate(-90deg);
            }

            .commander-damage-container {
                display: -webkit-box;
                display: -webkit-flex;
                display: flex;
                position: absolute;
            }

            .commander-damage-box {
                width: 40px;
                height: 40px;
                display: -webkit-box;
                display: -webkit-flex;
                display: flex;
                margin-right: 5px;
                -webkit-box-align: center;
                -webkit-align-items: center;
                align-items: center;
                -webkit-box-pack: center;
                -webkit-justify-content: center;
                justify-content: center;
                font-size: 1em;
                color: white;
                font-weight: bold;
                border-radius: 5px;
                cursor: pointer;
            }

            /* Partner commander boxes styling */
            .commander-damage-box.partner {
                height: 30px;
                font-size: 0.8em;
                margin-bottom: 2px;
            }

            .damage-1 {
                background-color: #238636;
            }

            .damage-3 {
                background-color: #fb8500;
            }

            .damage-2 {
                background-color: #1f6feb;
            }

            .damage-0 {
                background-color: #da3633;
            }

            /* Partner commander colors (darker versions) */
            .damage-1.partner {
                background-color: #1a6629;
            }

            .damage-3.partner {
                background-color: #d16a00;
            }

            .damage-2.partner {
                background-color: #1958c7;
            }

            .damage-0.partner {
                background-color: #b12b29;
            }

            .player0 .commander-damage-container {
                left: 5%;
                top: 50%;
                -webkit-transform: translateY(-50%) rotate(90deg);
                transform: translateY(-50%) rotate(90deg);
            }

            .player2 .commander-damage-container {
                left: 5%;
                top: 50%;
                -webkit-transform: translateY(-50%) rotate(90deg);
                transform: translateY(-50%) rotate(90deg);
            }

            .player1 .commander-damage-container {
                right: 5%;
                top: 50%;
                -webkit-transform: translateY(-50%) rotate(-90deg);
                transform: translateY(-50%) rotate(-90deg);
            }

            .player3 .commander-damage-container {
                right: 5%;
                top: 50%;
                -webkit-transform: translateY(-50%) rotate(-90deg);
                transform: translateY(-50%) rotate(-90deg);
            }

            .radial-menu {
                position: absolute;
                top: 50%;
                left: 50%;
                -webkit-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
                display: -webkit-box;
                display: -webkit-flex;
                display: flex;
                -webkit-box-pack: center;
                -webkit-justify-content: center;
                justify-content: center;
                -webkit-box-align: center;
                -webkit-align-items: center;
                align-items: center;
                z-index: 20;
                /* Make sure menu is on top */
            }

            .menu-button {
                font-size: 2em;
                background-color: #21262d;
                color: #f0f6fc;
                border: 1px solid #30363d;
                border-radius: 50%;
                padding: 20px;
                cursor: pointer;
                -webkit-transition: background 0.3s;
                transition: background 0.3s;
                z-index: 10;
                display: -webkit-box;
                display: -webkit-flex;
                display: flex;
                -webkit-box-pack: center;
                -webkit-justify-content: center;
                justify-content: center;
                -webkit-box-align: center;
                -webkit-align-items: center;
                align-items: center;
            }

            .menu-button:hover {
                background-color: #30363d;
            }

            .menu-option {
                position: absolute;
                width: 120px;
                height: 35px;
                background-color: #21262d;
                color: #f0f6fc;
                border: 1px solid #30363d;
                border-radius: 10px;
                display: -webkit-box;
                display: -webkit-flex;
                display: flex;
                -webkit-box-align: center;
                -webkit-align-items: center;
                align-items: center;
                -webkit-box-pack: center;
                -webkit-justify-content: center;
                justify-content: center;
                opacity: 0;
                -webkit-transition: all 0.3s;
                transition: all 0.3s;
                font-size: 1em;
                pointer-events: none;
            }

            .menu-open .menu-option {
                opacity: 1;
                pointer-events: auto;
            }

            .menu-option.restart {
                -webkit-transform: translate(-70px, -120px);
                transform: translate(-70px, -120px);
            }

            .menu-option.full-screen {
                -webkit-transform: translate(70px, -120px);
                transform: translate(70px, -120px);
            }

            .active-cmd-damage-div {
                background-image: -webkit-linear-gradient(rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.4) 100%);
                background-image: linear-gradient(rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.4) 100%);
            }

            .disabled {
                pointer-events: none;
                display: none;
            }

            .hidden-container {
                pointer-events: none;
                opacity: 0.3;
            }

            .enabled-div {
                pointer-events: auto;
                opacity: 1;
            }

            /* New styles for the death feature */
            .player-dead {
                background-image: -webkit-linear-gradient(rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.4) 100%);
                background-image: linear-gradient(rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.4) 100%);
            }

            .skull {
                position: absolute;
                font-size: 5em;
                z-index: 5;
                pointer-events: none;
                top: 50%;
                left: 50%;
                display: none;
                /* Hide by default */
            }

            .player0 .skull,
            .player2 .skull {
                -webkit-transform: translate(-50%, -50%) rotate(90deg);
                transform: translate(-50%, -50%) rotate(90deg);
            }

            .player1 .skull,
            .player3 .skull {
                -webkit-transform: translate(-50%, -50%) rotate(-90deg);
                transform: translate(-50%, -50%) rotate(-90deg);
            }

            /* Hide life total when player is dead */
            .player-dead .life-total {
                display: none;
            }

            .partner-split-container {
                display: -webkit-box;
                display: -webkit-flex;
                display: flex;
                -webkit-box-pack: center;
                -webkit-justify-content: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                position: absolute;
                padding: 0;
                /* iOS 9.3.5 fallback */
                -webkit-box-align: center;
                -webkit-align-items: center;
                align-items: center;
                top: 0;
            }

            .partner-half {
                -webkit-box-flex: 0;
                -webkit-flex: 0 1 45%;
                flex: 0 1 45%;
                display: -webkit-box;
                display: -webkit-flex;
                display: flex;
                -webkit-box-orient: vertical;
                -webkit-box-direction: normal;
                -webkit-flex-direction: column;
                flex-direction: column;
                -webkit-box-align: center;
                -webkit-align-items: center;
                align-items: center;
                -webkit-box-pack: center;
                -webkit-justify-content: center;
                justify-content: center;
                position: relative;
                height: 100%;
                /* Ensure consistent spacing */
                margin: 0 2%;
            }

            .partner-damage {
                position: relative !important;
                width: 90%;
                height: 33.33%;
                -webkit-transform-style: preserve-3d;
                transform-style: preserve-3d;
                text-align: center;
                /* iOS 9.3.5 centering fallback */
                display: -webkit-box;
                display: -webkit-flex;
                display: flex;
                -webkit-box-align: center;
                -webkit-align-items: center;
                align-items: center;
                -webkit-box-pack: center;
                -webkit-justify-content: center;
                justify-content: center;
                /* Better positioning for iOS 9.3.5 */
                margin: 0 auto;
            }

            .Quarter-left {
                left: auto !important;
                -webkit-transform: translateX(0);
                transform: translateX(0);
            }

            .Quarter-right {
                right: auto !important;
                -webkit-transform: translateX(0);
                transform: translateX(0);
            }

            .regular-commander-damage,
            .partner-damage-0,
            .partner-damage-1 {
                position: absolute;
                font-size: 1.5em; /* Reduced from 2em */
                font-weight: bold;
                color: black;
                /* iOS 9.3.5 centering with better positioning */
                /*top: 40%; /* Moved up from 50% */
                left: 50%;
                -webkit-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
                margin: 0;
                padding: 0;
                line-height: 1;
                text-align: center;
                width: auto;
                height: auto;
                /* Ensure text stays centered */
                white-space: nowrap;
                top:auto;
                left: auto;
                right: auto;
            }

            .partner-damage-1.partner-damage {
                top: 2%;
                right: 5%;
                left: 5%;
            }

            .partner-damage-0.regular-commander-damage {
                top: 30%;
            }

            .partner-damage .minus {
                position: absolute;
                left: 50% !important;
                /*top: 75% !important;*/
                -webkit-transform: translateX(-50%);
                transform: translateX(-50%);
                margin: 0;
                padding: 0;
                font-size: 2em; /* Reduced from 3em */
            }

            .partner-damage .plus {
                position: absolute;
                left: 50% !important;
                top: 25% !important;
                /*-webkit-transform: translateX(-50%);
                transform: translateX(-50%);*/
                margin: 0;
                padding: 0;
                font-size: 2em; /* Reduced from 3em */
            }

            .partner-damage .tap-counter {
                position: absolute;
                left: 50%;
                font-size: 0.8em;
                -webkit-transform: translateX(-50%);
                transform: translateX(-50%);
                margin: 0;
                padding: 0;
                color: black;
                font-weight: bold;
                opacity: 0;
                -webkit-transition: opacity 0.2s;
                transition: opacity 0.2s;
                pointer-events: none;
                line-height: 1;
                text-align: center;
                width: auto;
            }

            .partner-damage.top-half .tap-counter {
                top: 8%; /* Moved up slightly */
            }

            .partner-damage.bottom-half .tap-counter {
                bottom: 8%; /* Moved up slightly */
            }

            /* Enhanced iOS 9.3.5 specific fallbacks */
            @supports (-webkit-overflow-scrolling: touch) {
                .partner-split-container {
                    display: -webkit-box;
                    -webkit-box-align: center;
                    -webkit-box-pack: center;
                    top: 0;
                }

                .partner-half {
                    -webkit-box-flex: 0;
                    -webkit-box-orient: vertical;
                    -webkit-box-align: center;
                    -webkit-box-pack: center;
                    width: 45%;
                    margin: 0 2%;
                }

                .partner-damage {
                    display: -webkit-box;
                    -webkit-box-align: center;
                    -webkit-box-pack: center;
                    width: 90%;
                    margin: 0 auto;
                }

                .regular-commander-damage,
                .partner-damage-0,
                .partner-damage-1 {
                    position: absolute;
                    left: 50%;
                    -webkit-transform: translate(-50%, -50%);
                    transform: translate(-50%, -50%);
                    display: block;
                    text-align: center;
                    white-space: nowrap;
                    font-size: 1.5em; /* Consistent reduced size */
                }
            }

            /* Additional iOS 9.3.5 viewport fixes */
            @media screen and (-webkit-min-device-pixel-ratio: 0) {
                .partner-split-container {
                    left: -5%;
                    top: 0;
                }
                
                .partner-damage {
                    -webkit-box-sizing: border-box;
                    box-sizing: border-box;
                    width: 90%;
                    margin: 0 auto;
                }
                
                .regular-commander-damage,
                .partner-damage-0,
                .partner-damage-1 {
                    -webkit-font-smoothing: antialiased;
                    -moz-osx-font-smoothing: grayscale;
                    white-space: nowrap;
                    font-size: 1.5em; /* Consistent reduced size */
                }
            }
        </style>
    </head>
    <body>
        <div class="grid-container" id="gridContainer">
            <!-- Player 1 Container (top-left) -->
            <div class="player-container top-left" id="container0">
                <div class="settings-panel top-left">
                    <div class="setting-btn" onclick="resetPlayerLife(0)">Reset Life</div>
                    <div class="setting-btn" id="toggleDeadBtn0" onclick="togglePlayerDead(0)">Mark Dead</div>
                    <div class="setting-btn" onclick="resetCommanderDamage(0)">Reset Cmd DMG</div>
                    <div class="setting-btn partner-toggle" id="partnerToggle0" onclick="togglePartnerMode(0)">Partner Mode:
                        OFF</div>

                    <!-- New Poison Counter Control -->
                    <div class="poison-counter-container">
                        <div class="poison-arrow" onclick="adjustPoisonCounter(0, -1)">−</div>
                        <div class="poison-display">
                            <div class="poison-value" id="poison-value-0">0</div>
                            <div class="poison-symbol">☠</div>
                        </div>
                        <div class="poison-arrow" onclick="adjustPoisonCounter(0, 1)">+</div>
                    </div>
                </div>
                <div class="player player0" id="player0">
                    <div class="arrow-indicator">⚙️</div>
                    <div class="command-damage disabled damage-0">▶️ Click to Exit</div>
                    <div class="life-total" id="life0">40</div>
                    <div class="skull" id="skull0">☠️</div>
                    <div class="poison-indicator" id="poison-indicator-0">0 ☠</div>

                    <div class="half top-half basic-commander" onclick="tapLife(0, -1, this)">
                        <div class="minus">-</div>
                        <div class="tap-counter" id="tapCounter0Minus">-1</div>
                    </div>
                    <div class="half bottom-half basic-commander" onclick="tapLife(0, 1, this)">
                        <div class="plus">+</div>
                        <div class="tap-counter" id="tapCounter0Plus">+1</div>
                    </div>

                    <div class="commander-damage-container" id="commander-damage-container0">
                        <div>
                            <div class="commander-damage-box damage-1 enemy-partner-0" onclick="adjustCommanderDamage(0)">0</div>
                            <div class="commander-damage-box damage-1 partner enemy-partner-1" onclick="adjustCommanderDamage(0)"
                                style="display: none;">0</div>
                        </div>
                        <div>
                            <div class="commander-damage-box damage-2 enemy-partner-0" onclick="adjustCommanderDamage(0)">0</div>
                            <div class="commander-damage-box damage-2 partner enemy-partner-1" onclick="adjustCommanderDamage(0)"
                                style="display: none;">0</div>
                        </div>
                        <div>
                            <div class="commander-damage-box damage-3 enemy-partner-0" onclick="adjustCommanderDamage(0)">0</div>
                            <div class="commander-damage-box damage-3 partner enemy-partner-1" onclick="adjustCommanderDamage(0)"
                                style="display: none;">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Player 2 Container (top-right) -->
            <div class="player-container top-right" id="container1">
                <div class="settings-panel top-right">
                    <div class="setting-btn" onclick="resetPlayerLife(1)">Reset Life</div>
                    <div class="setting-btn" id="toggleDeadBtn1" onclick="togglePlayerDead(1)">Mark Dead</div>
                    <div class="setting-btn" onclick="resetCommanderDamage(1)">Reset Cmd DMG</div>
                    <div class="setting-btn partner-toggle" id="partnerToggle1" onclick="togglePartnerMode(1)">Partner Mode:
                        OFF</div>

                    <!-- New Poison Counter Control -->
                    <div class="poison-counter-container">
                        <div class="poison-arrow" onclick="adjustPoisonCounter(1, -1)">−</div>
                        <div class="poison-display">
                            <div class="poison-value" id="poison-value-1">0</div>
                            <div class="poison-symbol">☠</div>
                        </div>
                        <div class="poison-arrow" onclick="adjustPoisonCounter(1, 1)">+</div>
                    </div>
                </div>
                <div class="player player1" id="player1">
                    <div class="arrow-indicator">⚙️</div>
                    <div class="command-damage disabled damage-1">▶️ Click to Exit</div>
                    <div class="life-total" id="life1">40</div>
                    <div class="skull" id="skull1">☠️</div>
                    <div class="poison-indicator" id="poison-indicator-1">0 ☠</div>
                    <div class="half top-half basic-commander" onclick="tapLife(1, 1, this)">
                        <div class="plus">+</div>
                        <div class="tap-counter" id="tapCounter1Plus">+1</div>
                    </div>
                    <div class="half bottom-half basic-commander" onclick="tapLife(1, -1, this)">
                        <div class="minus">-</div>
                        <div class="tap-counter" id="tapCounter1Minus">-1</div>
                    </div>

                    <div class="commander-damage-container" id="commander-damage-container1">
                        <div>
                            <div class="commander-damage-box damage-0 enemy-partner-0" onclick="adjustCommanderDamage(1)">0</div>
                            <div class="commander-damage-box damage-0 partner enemy-partner-1" onclick="adjustCommanderDamage(1)"
                                style="display: none;">0</div>
                        </div>
                        <div>
                            <div class="commander-damage-box damage-2 enemy-partner-0" onclick="adjustCommanderDamage(1)">0</div>
                            <div class="commander-damage-box damage-2 partner enemy-partner-1" onclick="adjustCommanderDamage(1)"
                                style="display: none;">0</div>
                        </div>
                        <div>
                            <div class="commander-damage-box damage-3 enemy-partner-0" onclick="adjustCommanderDamage(1)">0</div>
                            <div class="commander-damage-box damage-3 partner enemy-partner-1" onclick="adjustCommanderDamage(1)"
                                style="display: none;">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Player 3 Container (bottom-left) -->
            <div class="player-container bottom-left" id="container2">
                <div class="settings-panel bottom-left">
                    <div class="setting-btn" onclick="resetPlayerLife(2)">Reset Life</div>
                    <div class="setting-btn" id="toggleDeadBtn2" onclick="togglePlayerDead(2)">Mark Dead</div>
                    <div class="setting-btn" onclick="resetCommanderDamage(2)">Reset Cmd DMG</div>
                    <div class="setting-btn partner-toggle" id="partnerToggle2" onclick="togglePartnerMode(2)">Partner Mode:
                        OFF</div>

                    <!-- New Poison Counter Control -->
                    <div class="poison-counter-container">
                        <div class="poison-arrow" onclick="adjustPoisonCounter(2, -1)">−</div>
                        <div class="poison-display">
                            <div class="poison-value" id="poison-value-2">0</div>
                            <div class="poison-symbol">☠</div>
                        </div>
                        <div class="poison-arrow" onclick="adjustPoisonCounter(2, 1)">+</div>
                    </div>
                </div>
                <div class="player player2" id="player2">
                    <div class="arrow-indicator">⚙️</div>
                    <div class="command-damage disabled damage-2">▶️ Click to Exit</div>
                    <div class="life-total" id="life2">40</div>
                    <div class="skull" id="skull2">☠️</div>
                    <div class="poison-indicator" id="poison-indicator-2">0 ☠</div>
                    <div class="half top-half basic-commander" onclick="tapLife(2, -1, this)">
                        <div class="minus">-</div>
                        <div class="tap-counter" id="tapCounter2Minus">-1</div>
                    </div>
                    <div class="half bottom-half basic-commander" onclick="tapLife(2, 1, this)">
                        <div class="plus">+</div>
                        <div class="tap-counter" id="tapCounter2Plus">+1</div>
                    </div>

                    <div class="commander-damage-container" id="commander-damage-container2">
                        <div>
                            <div class="commander-damage-box damage-0 enemy-partner-0" onclick="adjustCommanderDamage(2)">0</div>
                            <div class="commander-damage-box damage-0 partner enemy-partner-1" onclick="adjustCommanderDamage(2)"
                                style="display: none;">0</div>
                        </div>
                        <div>
                            <div class="commander-damage-box damage-1 enemy-partner-0" onclick="adjustCommanderDamage(2)">0</div>
                            <div class="commander-damage-box damage-1 partner enemy-partner-1" onclick="adjustCommanderDamage(2)"
                                style="display: none;">0</div>
                        </div>
                        <div>
                            <div class="commander-damage-box damage-3 enemy-partner-0" onclick="adjustCommanderDamage(2)">0</div>
                            <div class="commander-damage-box damage-3 partner enemy-partner-1" onclick="adjustCommanderDamage(2)"
                                style="display: none;">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Player 4 Container (bottom-right) -->
            <div class="player-container bottom-right" id="container3">
                <div class="settings-panel bottom-right">
                    <div class="setting-btn" onclick="resetPlayerLife(3)">Reset Life</div>
                    <div class="setting-btn" id="toggleDeadBtn3" onclick="togglePlayerDead(3)">Mark Dead</div>
                    <div class="setting-btn" onclick="resetCommanderDamage(3)">Reset Cmd DMG</div>
                    <div class="setting-btn partner-toggle" id="partnerToggle3" onclick="togglePartnerMode(3)">Partner Mode:
                        OFF</div>

                    <!-- New Poison Counter Control -->
                    <div class="poison-counter-container">
                        <div class="poison-arrow" onclick="adjustPoisonCounter(3, -1)">−</div>
                        <div class="poison-display">
                            <div class="poison-value" id="poison-value-3">0</div>
                            <div class="poison-symbol">☠</div>
                        </div>
                        <div class="poison-arrow" onclick="adjustPoisonCounter(3, 1)">+</div>
                    </div>
                </div>
                <div class="player player3" id="player3">
                    <div class="arrow-indicator">⚙️</div>
                    <div class="command-damage disabled damage-3">▶️ Click to Exit</div>
                    <div class="life-total" id="life3">40</div>
                    <div class="skull" id="skull3">☠️</div>
                    <div class="poison-indicator" id="poison-indicator-3">0 ☠</div>
                    <div class="half top-half basic-commander" onclick="tapLife(3, 1, this)">
                        <div class="plus">+</div>
                        <div class="tap-counter" id="tapCounter3Plus">+1</div>
                    </div>
                    <div class="half bottom-half basic-commander" onclick="tapLife(3, -1, this)">
                        <div class="minus">-</div>
                        <div class="tap-counter" id="tapCounter3Minus">-1</div>
                    </div>

                    <div class="commander-damage-container" id="commander-damage-container3">
                        <div>
                            <div class="commander-damage-box damage-0 enemy-partner-0" onclick="adjustCommanderDamage(3)">0</div>
                            <div class="commander-damage-box damage-0 partner enemy-partner-1" onclick="adjustCommanderDamage(3)"
                                style="display: none;">0</div>
                        </div>
                        <div>
                            <div class="commander-damage-box damage-1 enemy-partner-0" onclick="adjustCommanderDamage(3)">0</div>
                            <div class="commander-damage-box damage-1 partner enemy-partner-1" onclick="adjustCommanderDamage(3)"
                                style="display: none;">0</div>
                        </div>
                        <div>
                            <div class="commander-damage-box damage-2 enemy-partner-0" onclick="adjustCommanderDamage(3)">0</div>
                            <div class="commander-damage-box damage-2 partner enemy-partner-1" onclick="adjustCommanderDamage(3)"
                                style="display: none;">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="radial-menu" id="radialMenu">
                <div class="menu-button" onclick="toggleMenu()">Menu</div>
                <div class="menu-option restart" onclick="restartGame()">RESTART</div>
            </div>
        </div>

    </body>
    <script>
        var playerLives = [40, 40, 40, 40];
        var numberOfPlayers = playerLives.length;
        var commanderDamages = [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]]; // Array to track commander damage for each player against others
        var partnerCommanderDamages = [[[0, 0], [0, 0], [0, 0]], [[0, 0], [0, 0], [0, 0]], [[0, 0], [0, 0], [0, 0]], [[0, 0], [0, 0], [0, 0]]]; // Array to track partner commander damage [targetPlayer][opponentIndex][partnerNumber]
        var playersDead = [false, false, false, false]; // Track player death status
        var poisonCounters = [0, 0, 0, 0]; // New: Track poison counters for each player
        var partnerMode = [false, false, false, false]; // Track which players have partner commanders
        var tapCounts = { plus: [0, 0, 0, 0], minus: [0, 0, 0, 0] };
        var partnerTapCounts = { plus: [[0, 0], [0, 0], [0, 0], [0, 0]], minus: [[0, 0], [0, 0], [0, 0], [0, 0]] };
        var tapTimeouts = { plus: [null, null, null, null], minus: [null, null, null, null] };
        var partnerTapTimeouts = { plus: [[null,null], [null,null], [null,null], [null,null]], minus: [[null,null], [null,null], [null,null], [null,null]] };
        var inCommanderDamageMode = false; // Track if any player is in commander damage mode
        var activePlayerPanel = -1; // Track which player's panel is slid out

        // Touch event variables
        var touchStartX = 0;
        var touchStartY = 0;

        // Initialize: Hide all skulls and set up touch events
        window.onload = function () {
            for (var i = 0; i < 4; i++) {
                document.getElementById("skull" + i).style.display = "none";
                setupTouchEvents(i);
                updatePoisonIndicator(i); // Initialize poison indicators

                // Remove any existing partner containers (they'll be created dynamically when needed)
                var playerElement = document.getElementById("player" + i);
                var partnerContainer = playerElement.querySelector(".partner-split-container");
                if (partnerContainer) {
                    playerElement.removeChild(partnerContainer);
                }
            }
        };

        function AppendPartnerBoxes(player) {
            log("Appending partner boxes for player " + player);

            // Check if partner container already exists
            var playerElement = document.getElementById("player" + player);
            var existingPartnerContainer = playerElement.querySelector(".partner-split-container");
            
            // Only create and append if it doesn't exist
            if (!existingPartnerContainer) {
                var partnerContainer = createPartnerContainer(player);
                playerElement.appendChild(partnerContainer);
            }

            hideElements(document.querySelector("#player" + player + " .minus"));
            hideElements(document.querySelector("#player" + player + " .plus"));
            hideElements(document.querySelector("#player" + player + " .half"));
        }

        function RemovePartnerBoxes(player) {
            log("Removing partner boxes for player " + player);

            // Remove the partner container from the DOM
            var playerElement = document.getElementById("player" + player);
            var partnerContainer = playerElement.querySelector(".partner-split-container");
            if (partnerContainer) {
                playerElement.removeChild(partnerContainer);
            }

            showElements(document.querySelector("#player" + player + " .minus"));
            showElements(document.querySelector("#player" + player + " .plus"));
            showElements(document.querySelector("#player" + player + " .half"));
        }

        function togglePartnerMode(player) {
            partnerMode[player] = !partnerMode[player];
            var toggleBtn = document.getElementById("partnerToggle" + player);

            if (partnerMode[player]) {
                toggleBtn.textContent = "Partner Mode: ON";
                addClass(toggleBtn, "active");
            }
            else {
                toggleBtn.textContent = "Partner Mode: OFF";
                removeClass(toggleBtn, "active");

                // Show basic commander buttons when partner mode is off
                var playerElement = document.getElementById("player" + player);
                var basicCommanderButtons = playerElement.querySelectorAll(".basic-commander");
                for (var i = 0; i < basicCommanderButtons.length; i++) {
                    basicCommanderButtons[i].style.removeProperty('display');
                }

                // Reset partner commander damage FROM this player to all other players
                for (var i = 0; i < 4; i++) {
                    if (i !== player) {
                        var dmgIdx = (player < i) ? player : player - 1;
                        partnerCommanderDamages[i][dmgIdx] = 0;
                        
                        // Reset the partner damage box text to 0
                        var partnerBox = document.querySelector("#player" + i + " .commander-damage-box.damage-" + player + ".partner");
                        if (partnerBox) {
                            partnerBox.textContent = "0";
                        }
                    }
                }
            }

            updateAllPartnerBoxVisibility();

            // Close the panel
            togglePlayerPanel(player);
        }

        // Helper function to create the partner container with the right structure
        function createPartnerContainer(player) {
            var container = document.createElement('div');
            container.className = 'partner-split-container';

            // First partner half
            var firstHalf = document.createElement('div');
            firstHalf.className = 'partner-half';

            // Second partner half
            var secondHalf = document.createElement('div');
            secondHalf.className = 'partner-half';

            // Determine rotation based on player position
            var rotation = (player === 1 || player === 3) ? 'rotate(-90deg)' : 'rotate(90deg)';

            // Create elements for first half
            var topHalf1 = document.createElement('div');
            topHalf1.className = 'partner-damage half Quarter-left top-half';
            topHalf1.innerHTML = '<div style="transform: ' + rotation + ';" class="minus">-</div><div style="transform: ' + rotation + ';" class="tap-counter" id="tapCounter' + player + 'Minus">-1</div>';
            topHalf1.onclick = function() { tapPartnerDamage(player, -1, this, 0) }; // Associated with Partner 0
            log(topHalf1);

            var middle1 = document.createElement('div');
            middle1.className = 'partner-damage half';
            middle1.innerHTML = '<div class="regular-commander-damage partner-damage-0" style="transform: ' + rotation + ';" >0</div>';

            var bottomHalf1 = document.createElement('div');
            bottomHalf1.className = 'partner-damage half Quarter-left bottom-half';
            bottomHalf1.innerHTML = '<div style="transform: ' + rotation + ';" class="plus">+</div><div style="transform: ' + rotation + ';" class="tap-counter" id="tapCounter' + player + 'Plus">+1</div>';
            bottomHalf1.onclick = function() { tapPartnerDamage(player, 1, this, 0) }; // Associated with Partner 0

            // Create elements for second half
            var topHalf2 = document.createElement('div');
            topHalf2.className = 'partner-damage half Quarter-right top-half';
            topHalf2.innerHTML = '<div style="transform: ' + rotation + ';" class="minus">-</div><div style="transform: ' + rotation + ';" class="tap-counter" id="tapCounter' + player + 'Minus">-1</div>';
            topHalf2.onclick = function() { tapPartnerDamage(player, -1, this, 1) }; // Associated with Partner 1

            var middle2 = document.createElement('div');
            middle2.className = 'partner-damage half';
            middle2.innerHTML = '<div style="transform: ' + rotation + ';" class="partner-damage partner-damage-1">0</div>';

            var bottomHalf2 = document.createElement('div');
            bottomHalf2.className = 'partner-damage half Quarter-right bottom-half';
            bottomHalf2.innerHTML = '<div style="transform: ' + rotation + ';" class="plus">+</div><div style="transform: ' + rotation + ';" class="tap-counter" id="tapCounter' + player + 'Plus">+1</div>';
            bottomHalf2.onclick = function() { tapPartnerDamage(player, 1, this, 1) }; // Associated with Partner 1

            // Assemble the structure
            firstHalf.appendChild(topHalf1);
            firstHalf.appendChild(middle1);
            firstHalf.appendChild(bottomHalf1);

            secondHalf.appendChild(topHalf2);
            secondHalf.appendChild(middle2);
            secondHalf.appendChild(bottomHalf2);

            container.appendChild(firstHalf);
            container.appendChild(secondHalf);

            return container;
        }

        function updateAllPartnerBoxVisibility() {
            // For each player, show/hide partner damage boxes based on other players' partner mode
            for (var targetPlayer = 0; targetPlayer < 4; targetPlayer++) {
                for (var sourcePlayer = 0; sourcePlayer < 4; sourcePlayer++) {
                    if (sourcePlayer !== targetPlayer) {
                        var partnerBox = document.querySelector("#player" + targetPlayer + " .commander-damage-box.damage-" + sourcePlayer + ".partner");
                        if (partnerBox) {
                            if (partnerMode[sourcePlayer]) {
                                partnerBox.style.display = "flex";
                            } else {
                                partnerBox.style.display = "none";
                            }
                        }
                    }
                }
            }
        }

        function togglePlayerPanel(playerIndex) {
            var containerElement = document.getElementById("container" + playerIndex);

            // If panel already active, close it
            if (activePlayerPanel === playerIndex) {
                removeClass(containerElement, "active");
                activePlayerPanel = -1;
                return;
            }

            // If another panel is active, close it first
            if (activePlayerPanel !== -1) {
                removeClass(document.getElementById("container" + activePlayerPanel), "active");
            }

            // Open this panel
            addClass(containerElement, "active");
            activePlayerPanel = playerIndex;

            // Update toggle button text based on current state
            updateToggleButtonText(playerIndex);
        }

        function setupTouchEvents(playerIndex) {
            var playerElement = document.getElementById("player" + playerIndex);
            var containerElement = document.getElementById("container" + playerIndex);

            // Arrow indicator click handler
            playerElement.querySelector(".arrow-indicator").addEventListener("click", function (e) {
                e.stopPropagation(); // Prevent event from bubbling to player element
                togglePlayerPanel(playerIndex);
            });

            // Setup touch events for swipe
            playerElement.addEventListener('touchstart', function (e) {
                if (inCommanderDamageMode) return; // Don't allow swipe during commander damage mode

                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, false);

            playerElement.addEventListener('touchmove', function (e) {
                if (inCommanderDamageMode) return;

                var touchX = e.touches[0].clientX;
                var touchY = e.touches[0].clientY;

                var deltaX = touchX - touchStartX;
                var deltaY = touchY - touchStartY;

                // If more horizontal than vertical movement, it's a horizontal swipe
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    e.preventDefault(); // Prevent scrolling
                }
            }, false);

            playerElement.addEventListener('touchend', function (e) {
                if (inCommanderDamageMode) return;

                var touchEndX = e.changedTouches[0].clientX;
                var touchEndY = e.changedTouches[0].clientY;

                var deltaX = touchEndX - touchStartX;
                var deltaY = touchEndY - touchStartY;

                // If more horizontal than vertical movement and significant swipe
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                    // For left players (0 and 2), swipe left to open
                    if ((playerIndex === 0 || playerIndex === 2) && deltaX < 0) {
                        togglePlayerPanel(playerIndex);
                    }
                    // For right players (1 and 3), swipe right to open
                    else if ((playerIndex === 1 || playerIndex === 3) && deltaX > 0) {
                        togglePlayerPanel(playerIndex);
                    }
                    // For all players, opposite swipe to close
                    else if (hasClass(containerElement, "active")) {
                        togglePlayerPanel(playerIndex);
                    }
                }
            }, false);
        }

        // Function to adjust poison counters
        function adjustPoisonCounter(player, change) {
            // Don't allow negative poison counters
            if (poisonCounters[player] + change < 0) return;

            poisonCounters[player] += change;
            document.getElementById("poison-value-" + player).textContent = poisonCounters[player];
            updatePoisonIndicator(player);

            // Check player status after poison counter change
            checkPlayerStatus(player);
        }

        // Function to update poison indicator visibility
        function updatePoisonIndicator(player) {
            var indicator = document.getElementById("poison-indicator-" + player);
            if (poisonCounters[player] > 0) {
                indicator.textContent = poisonCounters[player] + " ☠";
                addClass(indicator, "visible");
            } else {
                removeClass(indicator, "visible");
            }
        }

        // Function to reset poison counters
        function resetPoisonCounter(player) {
            poisonCounters[player] = 0;
            document.getElementById("poison-value-" + player).textContent = "0";
            updatePoisonIndicator(player);

            // Check if player should be revived
            checkPlayerStatus(player);
        }

        function updateToggleButtonText(playerIndex) {
            var button = document.getElementById("toggleDeadBtn" + playerIndex);
            button.textContent = playersDead[playerIndex] ? "Revive Player" : "Mark Dead";
        }

        function resetPlayerLife(player) {
            playerLives[player] = 40;
            document.getElementById("life" + player).textContent = "40";
            if (playersDead[player]) {
                revivePlayer(player);
            }

            // Close the panel
            togglePlayerPanel(player);
        }

        function togglePlayerDead(player) {
            if (playersDead[player]) {
                revivePlayer(player);
            } else {
                killPlayer(player);
            }

            // Update the button text
            updateToggleButtonText(player);
        }

        function resetCommanderDamage(player) {
            console.log("Resetting commander damage for player " + player);

            // Reset all commander damage dealt TO this player
            for (var i = 0; i < 3; i++) {
                commanderDamages[player][i] = 0;
                partnerCommanderDamages[player][i][0] = 0;
                partnerCommanderDamages[player][i][1] = 0;
            }

            // Reset all commander damage boxes showing damage TO this player
            for (var i = 0; i < 4; i++) {
                if (i !== player) {
                    var mainBox = document.querySelector("#player" + player + " .commander-damage-box.damage-" + i + ":not(.partner)");
                    var partnerBox = document.querySelector("#player" + player + " .commander-damage-box.damage-" + i + ".partner");
                    if (mainBox) {
                        mainBox.textContent = "0";
                    }
                    if (partnerBox) {
                        partnerBox.textContent = "0";
                    }
                }
            }

            // Check if player should be revived after resetting damage
            checkPlayerStatus(player);

            // Close the panel
            togglePlayerPanel(player);
        }

        function tapPartnerDamage(player, change, divElement, partnerNumber) 
        {
            var partnerDamageDiv = document.querySelector(`#player${player}`).querySelector(`.partner-damage-${partnerNumber}`);
            var currentActivePartnerDamageTotal = parseInt(partnerDamageDiv.textContent);
            currentActivePartnerDamageTotal += change;
            partnerDamageDiv.textContent = currentActivePartnerDamageTotal;

            var cmdDamagePlayerLife = document.querySelector(".player.active-cmd-damage-div");
            var cmdDamagePlayerNumber = cmdDamagePlayerLife.id[cmdDamagePlayerLife.id.length - 1];
            log(`Partner damage taken from player ${player} by Partner ${partnerNumber} with change of ${change} to player ${cmdDamagePlayerNumber}`);
        
            // Update the commander damage for tracking - FIX: Track each partner separately
            var targetPlayer = parseInt(cmdDamagePlayerNumber);
            var fromPlayer = player;
            var dmgIdx = (fromPlayer < targetPlayer) ? fromPlayer : fromPlayer - 1;
            partnerCommanderDamages[targetPlayer][dmgIdx][partnerNumber] = currentActivePartnerDamageTotal;

            playerLives[cmdDamagePlayerNumber] += (change * -1);
            document.getElementById("life" + cmdDamagePlayerNumber).textContent = playerLives[cmdDamagePlayerNumber];
            document.querySelector(`#player${cmdDamagePlayerNumber} .enemy-partner-${partnerNumber}`).textContent = currentActivePartnerDamageTotal;

            // Check player status after partner damage and life change
            checkPlayerStatus(cmdDamagePlayerNumber);

            // Add partner damage dimmed effect for small counters
            var isPlus = change > 0;
            var tapType = isPlus ? "plus" : "minus";
            
            partnerTapCounts[tapType][player][partnerNumber] += change;
            var tapCounter = divElement.querySelector(".tap-counter");
            tapCounter.textContent = (isPlus ? "+" : "") + partnerTapCounts[tapType][player][partnerNumber];
            addClass(tapCounter, "show");

            addClass(divElement, "dimmed");
            setTimeout(function () { removeClass(divElement, "dimmed"); }, 200);

            clearTimeout(partnerTapTimeouts[tapType][player][partnerNumber]);
            partnerTapTimeouts[tapType][player][partnerNumber] = setTimeout(function () {
                partnerTapCounts[tapType][player][partnerNumber] = 0;
                removeClass(tapCounter, "show");
            }, 2000);
        }

        function tapLife(player, change, divElement) {

            if(hasClass(divElement, "disabled")) {
                return;
            }

            // If a panel is open, close it first
            if (activePlayerPanel !== -1) {
                togglePlayerPanel(activePlayerPanel);
                return;
            }

            var isPlus = change > 0;
            var halfClass = divElement.classList.contains("top-half") ? "top-half" : "bottom-half";
            var counterId = isPlus ? "tapCounter" + player + "Plus" : "tapCounter" + player + "Minus";
            var counterElement = document.getElementById(counterId);
            var halfElement = document.querySelector("#player" + player + " ." + halfClass);
            var tapType = isPlus ? "plus" : "minus";
            var playerLife = document.querySelector("#player" + player).querySelector(".life-total");

            if (!hasClass(playerLife, "disabled")) {
                playerLives[player] += change;
                document.getElementById("life" + player).textContent = playerLives[player];

                // Check player status after life total change
                checkPlayerStatus(player);
            }
            else {
                log(`Player ${fromPlayer} has dealt commander damage to player ${player} with change of ${change}`);
                var commandDamage = document.querySelector("#player" + player).querySelector(".command-damage");
                var totalCmdDamage = parseInt(commandDamage.textContent);
                totalCmdDamage += change;
                var cmdDamagePlayerLife = document.querySelector(".player.active-cmd-damage-div");
                var cmdDamagePlayerNumber = cmdDamagePlayerLife.id[cmdDamagePlayerLife.id.length - 1];

                // Update the commander damage for tracking
                var targetPlayer = parseInt(cmdDamagePlayerNumber);
                var fromPlayer = player;
                var dmgIdx = (fromPlayer < targetPlayer) ? fromPlayer : fromPlayer - 1;
                commanderDamages[targetPlayer][dmgIdx] = totalCmdDamage;

                playerLives[cmdDamagePlayerNumber] += (change * -1);
                document.getElementById("life" + cmdDamagePlayerNumber).textContent = playerLives[cmdDamagePlayerNumber];
                commandDamage.textContent = totalCmdDamage;

                // Update boxes with current damage values
                document.getElementById("life" + cmdDamagePlayerNumber).textContent = playerLives[cmdDamagePlayerNumber];
                document.querySelector(`#player${cmdDamagePlayerNumber} .damage-${fromPlayer}`).textContent = totalCmdDamage;

                // Check player status after commander damage and life change
                checkPlayerStatus(cmdDamagePlayerNumber);
            }

            tapCounts[tapType][player] += change;
            counterElement.textContent = (isPlus ? "+" : "") + tapCounts[tapType][player];
            addClass(counterElement, "show");

            addClass(halfElement, "dimmed");
            setTimeout(function () { removeClass(halfElement, "dimmed"); }, 200);

            clearTimeout(tapTimeouts[tapType][player]);
            tapTimeouts[tapType][player] = setTimeout(function () {
                tapCounts[tapType][player] = 0;
                removeClass(counterElement, "show");
            }, 2000);
        }

        function updateCommanderDamageBoxes(targetPlayer) {
            for (var i = 0; i < 4; i++) {
                if (i !== targetPlayer) {
                    var dmgIdx = (i < targetPlayer) ? i : i - 1;
                    var mainBox = document.querySelector("#player" + targetPlayer + " .commander-damage-box.damage-" + i + ":not(.partner)");
                    var partnerBox = document.querySelector("#player" + targetPlayer + " .commander-damage-box.damage-" + i + ".partner");

                    if (mainBox) {
                        mainBox.textContent = commanderDamages[targetPlayer][dmgIdx];
                    }
                    if (partnerBox) {
                        partnerBox.textContent = partnerCommanderDamages[targetPlayer][dmgIdx];
                    }
                }
            }
        }

        function killPlayer(player) {
            console.log(`kill ${player}`);
            if (playersDead[player]) return; // If already dead, do nothing

            playersDead[player] = true;
            var playerElement = document.getElementById("player" + player);
            addClass(playerElement, "player-dead");

            // Show skull
            document.getElementById("skull" + player).style.display = "block";

            // Update button text if panel is open
            updateToggleButtonText(player);
        }

        function revivePlayer(player) {
            console.log(`Revive ${player}`);
            if (!playersDead[player]) return; // If not dead, do nothing

            playersDead[player] = false;
            var playerElement = document.getElementById("player" + player);
            removeClass(playerElement, "player-dead");

            // Hide skull
            document.getElementById("skull" + player).style.display = "none";

            // Update button text if panel is open
            updateToggleButtonText(player);
        }

        function checkPlayerStatus(player) {
            // This function checks if a player should be dead or alive based on their
            // current life total, commander damage values, and poison counters
            var shouldBeDead = false;

            // Check life total
            if (playerLives[player] <= 0) {
                shouldBeDead = true;
            }
            // Check poison counters
            else if (poisonCounters[player] >= 10) {
                shouldBeDead = true;
            }
            else {
                // Check all commander damages to this player (both main and partner)
                for (var i = 0; i < 3; i++) {
                    var damage = commanderDamages[player][i];
                    if (damage >= 21) {
                        shouldBeDead = true;
                        break;
                    }
                    
                    // Check both partner commanders for this opponent
                    var partnerDamage0 = partnerCommanderDamages[player][i][0];
                    var partnerDamage1 = partnerCommanderDamages[player][i][1];
                    if (partnerDamage0 >= 21 || partnerDamage1 >= 21) {
                        shouldBeDead = true;
                        break;
                    }
                }
            }

            // Update player state if needed
            if (shouldBeDead && !playersDead[player]) {
                killPlayer(player);
            } else if (!shouldBeDead && playersDead[player]) {
                revivePlayer(player);
            }
        }

        function adjustCommanderDamage(activePlayer) {
            // Close any open panel first
            if (activePlayerPanel !== -1) {
                togglePlayerPanel(activePlayerPanel);
                return;
            }

            // Don't allow entering commander damage mode if already in it
            if (inCommanderDamageMode) {
                return;
            }

            inCommanderDamageMode = true;

            var currentPlayer = document.querySelector(".player.player" + activePlayer);
            addClass(currentPlayer, "active-cmd-damage-div");
            addClass(currentPlayer.querySelector(".command-damage"), "active-cmd-damage-div");

            var lifeTotal = currentPlayer.querySelector(".life-total");
            addClass(lifeTotal, "disabled");

            var halfElements = currentPlayer.querySelectorAll(".half");
            addClass(halfElements, "disabled");
            
            setTimeout(function () {
                currentPlayer.setAttribute("onclick", "enableDiv(this)");
            }, 200);

            var commandDamageText = currentPlayer.querySelector(".command-damage");
            removeClass(commandDamageText, "disabled");

            // Disable life change on active player
            for (var i = 0; i < 4; i++) {
                if (i != activePlayer) {
                    var player = document.querySelector("#player" + i);
                    addClass(player.querySelector(".life-total"), "disabled");
                }
            }

            // Hide all other commander damage containers except for the active player
            for (var i = 0; i < 4; i++) {
                if (i !== activePlayer) {
                    var container = document.getElementById("commander-damage-container" + i);
                    addClass(container, "hidden-container");
                }
            }

            var arrows = document.querySelectorAll(".arrow-indicator");
            for (var i = 0; i < arrows.length; i++) {
                arrows[i].style.display = "none";
            }

            // Replace forEach with for loop for iOS 9.3.5 compatibility
            for (var index = 0; index < partnerMode.length; index++) {
                var isEnabled = partnerMode[index];
                if(isEnabled && index !== activePlayer) {
                    AppendPartnerBoxes(index);
                    log("Partner mode enabled for player " + index);
                }
            }

            for (var i = 0; i < numberOfPlayers; i++) 
            {
                if(i !== activePlayer) 
                {
                    var commanderDamageBox = document.querySelectorAll("#player" + activePlayer + " .commander-damage-box" + ".damage-" + i);
                    // Replace forEach with for loop
                    for (var j = 0; j < commanderDamageBox.length; j++) {
                        var box = commanderDamageBox[j];
                        var damageClass = getDamageClass(box);
                        var opponent = damageClass.replace("damage-", "");

                        // Player has partner commanders
                        if(partnerMode[opponent]) {
                            log(box + " " + getClass(box, 'enemy-partner-'));
                            AppendPartnerBoxes(opponent);
                            var partnerNumber = getClass(box, 'enemy-partner-').replace('enemy-partner-', '');
                            log("Active damage from " + opponent + " using Second Partner commander to " + activePlayer + " from partner: " + partnerNumber + " Current Total: " + box.textContent);
                            document.querySelector("#player" + opponent + " .partner-damage-" + partnerNumber).textContent = box.textContent;
                        } 
                        // Player only has 1 commander
                        else if(!box.classList.contains("partner"))
                        {                    
                            log("[No Partner Commanders] Active damage from " + opponent + " to " + activePlayer + ": " + box.textContent);
                            var damageCounter = document.querySelector(".command-damage." + damageClass);
                            damageCounter.textContent = parseInt(box.textContent);
                            removeClass(damageCounter, "disabled");
                        }
                    }
                }
            }
        }

        function enableDiv(currentPlayer) {
            log("Exiting commander damage mode");

            removeClass(currentPlayer, 'active-cmd-damage-div');
            currentPlayer.removeAttribute("onclick");
            var halfElements = currentPlayer.querySelectorAll(".half");
            
            for (var i = 0; i < halfElements.length; i++) {
                removeClass(halfElements[i], "disabled");
            }

            // Bring back all life totals - Replace forEach with for loop
            var players = document.querySelectorAll(".player");
            for (var i = 0; i < players.length; i++) {
                var player = players[i];
                player.querySelector(".command-damage").textContent = "▶️Click to Exit";
                removeClass(player.querySelector(".life-total"), "disabled");
                removeClass(player.querySelector(".command-damage"), "active-cmd-damage-div");
                removeClass(player.querySelector(".commander-damage-container"), "hidden-container");
                addClass(player.querySelector(".command-damage"), "disabled");
            }

            var arrows = document.querySelectorAll(".arrow-indicator");
            for (var i = 0; i < arrows.length; i++) {
                arrows[i].style.display = "block";
            }

            // Check if player status should change after updating commander damage
            for (var i = 0; i < numberOfPlayers; i++) {
                checkPlayerStatus(i);
            }

            // Remove partner boxes if any - Replace forEach with for loop
            for (var index = 0; index < partnerMode.length; index++) {
                var isEnabled = partnerMode[index];
                if(isEnabled) {
                    RemovePartnerBoxes(index);
                }
            }

            // Exit commander damage mode
            inCommanderDamageMode = false;
        }

        // Helper functions for classList compatibility
        function hasClass(element, className) {
            // Handle arrays, NodeLists, and other array-like objects
            if (element && element.length !== undefined && typeof element.length === 'number') {
                for (var i = 0; i < element.length; i++) {
                    hasClass(element[i], className);
                }
                return;
            }

            if (!element) return false;
            
            if (element.classList) {
                return element.classList.contains(className);
            }
            return (' ' + element.className + ' ').indexOf(' ' + className + ' ') > -1;
        }

        function addClass(element, className) {
            // Handle arrays, NodeLists, and other array-like objects
            if (element && element.length !== undefined && typeof element.length === 'number') {
                for (var i = 0; i < element.length; i++) {
                    addClass(element[i], className);
                }
                return;
            }

            if (!element) return;

            if (element.classList) {
                element.classList.add(className);
            } else if (!hasClass(element, className)) {
                element.className += ' ' + className;
            }
        }

        function removeClass(element, className) {
            // Handle arrays, NodeLists, and other array-like objects
            if (element && element.length !== undefined && typeof element.length === 'number') {
                for (var i = 0; i < element.length; i++) {
                    removeClass(element[i], className);
                }
                return;
            }

            if (!element) return;

            // Handle single element
            if (element.classList) {
                element.classList.remove(className);
            } else {
                element.className = element.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
            }
        }

        function getDamageClass(element) {
            return getClass(element, 'damage-');
        }

        function getClass(element, classPrefix)
        {
            var classes = element.className.split(' ');
            for (var i = 0; i < classes.length; i++) {
                if (classes[i].indexOf(classPrefix) === 0) {
                    return classes[i];
                }
            }
            return '';
        }

        function restartGame() {
            // Reset player lives
            playerLives = [40, 40, 40, 40];
            for (var i = 0; i < 4; i++) {
                document.getElementById("life" + i).textContent = "40";
                revivePlayer(i);
                resetPoisonCounter(i);
            }

            // Reset commander damages (both main and partner)
            commanderDamages = [[0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]];
            partnerCommanderDamages = [[[0, 0], [0, 0], [0, 0]], [[0, 0], [0, 0], [0, 0]], [[0, 0], [0, 0], [0, 0]], [[0, 0], [0, 0], [0, 0]]];
            
            // Reset player death status
            playersDead = [false, false, false, false];

            // Reset partner mode
            for (var i = 0; i < 4; i++) {
                if (partnerMode[i]) {
                    togglePartnerMode(i);
                }
            }

            // Reset commander damage mode
            inCommanderDamageMode = false;

            // Close any open panel

            if (activePlayerPanel !== -1) {
                togglePlayerPanel(activePlayerPanel);
            }

            // Make sure all commander damage containers are visible
            for (var i = 0; i < 4; i++) {
                var container = document.getElementById("commander-damage-container" + i);
                removeClass(container, "hidden-container");
            }

            var arrows = document.querySelectorAll(".arrow-indicator");
            for (var i = 0; i < arrows.length; i++) {
                               arrows[i].style.display = "block";
            }

            // Close menu
            removeClass(document.getElementById("radialMenu"), "menu-open");

            // Update toggle button texts
            for (var i = 0; i < 4; i++) {
                updateToggleButtonText(i);
            }
        }

        function hideElements(element) {
            // Handle arrays, NodeLists, and other array-like objects
            if (element && element.length !== undefined && typeof element.length === 'number') {
                for (var i = 0; i < element.length; i++) {
                    hideElements(element[i]);
                }
                return;
            }

            if (!element) return;

           

            element.style.display = "none";
            element.style.pointerEvents = "none";
            element.style.click = "none";
            addClass(element, "disabled");
        }

        function showElements(element, makeBlock) {
            // Handle arrays, NodeLists, and other array-like objects
            if (element && element.length !== undefined && typeof element.length === 'number') {
                for (var i = 0; i < element.length; i++) {
                    showElements(element[i]);
                }
                return;
            }

            if (!element) return;

            if (makeBlock) {
                element.style.display = "block";
            } else {
                element.style.removeProperty('display');
            }
            element.style.pointerEvents = "auto";
            removeClass(element, "disabled");
        }

        function log(message) {
            console.log(message);
        }

        function toggleMenu() {
            var menu = document.getElementById("radialMenu");
            if (hasClass(menu, "menu-open")) {
                removeClass(menu, "menu-open");
            } else {
                addClass(menu, "menu-open");

            }
        }
    </script>
</html>
